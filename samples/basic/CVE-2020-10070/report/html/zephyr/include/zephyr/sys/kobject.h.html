
<html>
<head>
<title>zephyr/include/zephyr/sys/kobject.h</title>
<link rel="stylesheet" type="text/css" href="../../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright (c) 2020 Intel Corporation</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * SPDX-License-Identifier: Apache-2.0</div><div id="5" class="line none">    5  */</div><div id="6" class="line none">    6 #ifndef <a href="kobject.h.html#7">ZEPHYR_INCLUDE_SYS_KOBJECT_H</a></div><div id="7" class="line none">    7 #define <a href="kobject.h.html#7">ZEPHYR_INCLUDE_SYS_KOBJECT_H</a></div><div id="8" class="line none">    8 </div><div id="9" class="line none">    9 #include &lt;stdint.h&gt;</div><div id="10" class="line none">   10 #include &lt;stddef.h&gt;</div><div id="11" class="line none">   11 </div><div id="12" class="line none">   12 #include &lt;zephyr/sys/iterable_sections.h&gt;</div><div id="13" class="line none">   13 #include &lt;zephyr/sys/<a href="../net/mqtt.h.html#496">internal</a>/kobject_internal.h&gt;</div><div id="14" class="line none">   14 </div><div id="15" class="line none">   15 #ifdef __cplusplus</div><div id="16" class="line none">   16 extern "C" {</div><div id="17" class="line none">   17 #endif</div><div id="18" class="line none">   18 </div><div id="19" class="line none">   19 struct <a href="../arch/arch_interface.h.html#43">k_thread</a>;</div><div id="20" class="line none">   20 struct <a href="kobject.h.html#20">k_mutex</a>;</div><div id="21" class="line none">   21 struct <a href="../kernel.h.html#2153">z_futex_data</a>;</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23 /**</div><div id="24" class="line none">   24  * @brief Kernel Object Types</div><div id="25" class="line none">   25  *</div><div id="26" class="line none">   26  * This enumeration needs to be kept in sync with the lists of kernel objects</div><div id="27" class="line none">   27  * and subsystems in scripts/build/gen_kobject_list.py, as well as the otype_to_str()</div><div id="28" class="line none">   28  * function in kernel/userspace.c</div><div id="29" class="line none">   29  */</div><div id="30" class="line none">   30 enum <a href="kobject.h.html#30">k_objects</a> {</div><div id="31" class="line none">   31         <a href="kobject.h.html#31">K_OBJ_ANY</a>,</div><div id="32" class="line none">   32 </div><div id="33" class="line none">   33         /** @cond</div><div id="34" class="line none">   34          *  Doxygen should ignore this build-time generated include file</div><div id="35" class="line none">   35          *  when generating API documentation.  Enumeration values are</div><div id="36" class="line none">   36          *  generated during build by gen_kobject_list.py.  It includes</div><div id="37" class="line none">   37          *  basic kernel objects (e.g.  pipes and mutexes) and driver types.</div><div id="38" class="line none">   38          */</div><div id="39" class="line none">   39 #include &lt;zephyr/kobj-types-enum.h&gt;</div><div id="40" class="line none">   40         /** @endcond</div><div id="41" class="line none">   41          */</div><div id="42" class="line none">   42 </div><div id="43" class="line none">   43         <a href="kobject.h.html#43">K_OBJ_LAST</a></div><div id="44" class="line none">   44 };</div><div id="45" class="line none">   45 /**</div><div id="46" class="line none">   46  * @defgroup usermode_apis User Mode APIs</div><div id="47" class="line none">   47  * @ingroup kernel_apis</div><div id="48" class="line none">   48  * @{</div><div id="49" class="line none">   49  */</div><div id="50" class="line none">   50 </div><div id="51" class="line none">   51 #ifdef CONFIG_USERSPACE</div><div id="52" class="line none">   52 </div><div id="53" class="line none">   53 /**</div><div id="54" class="line none">   54  * @brief Grant a static thread access to a list of kernel objects</div><div id="55" class="line none">   55  *</div><div id="56" class="line none">   56  * For threads declared with K_THREAD_DEFINE(), grant the thread access to</div><div id="57" class="line none">   57  * a set of kernel objects. These objects do not need to be in an initialized</div><div id="58" class="line none">   58  * state. The permissions will be granted when the threads are initialized</div><div id="59" class="line none">   59  * in the early boot sequence.</div><div id="60" class="line none">   60  *</div><div id="61" class="line none">   61  * All arguments beyond the first must be pointers to kernel objects.</div><div id="62" class="line none">   62  *</div><div id="63" class="line none">   63  * @param name_ Name of the thread, as passed to K_THREAD_DEFINE()</div><div id="64" class="line none">   64  */</div><div id="65" class="line none">   65 #define <a href="kobject.h.html#65">K_THREAD_ACCESS_GRANT</a>(name_, ...) \</div><div id="66" class="line none">   66         static void * const _CONCAT(_object_list_, name_)[] = \</div><div id="67" class="line none">   67                 { __VA_ARGS__, NULL }; \</div><div id="68" class="line none">   68         static const STRUCT_SECTION_ITERABLE(k_object_assignment, \</div><div id="69" class="line none">   69                                         _CONCAT(_object_access_, name_)) = \</div><div id="70" class="line none">   70                         { (&amp;_k_thread_obj_ ## name_), \</div><div id="71" class="line none">   71                           (_CONCAT(_object_list_, name_)) }</div><div id="72" class="line none">   72 </div><div id="73" class="line none">   73 /** Object initialized */</div><div id="74" class="line none">   74 #define <a href="kobject.h.html#74">K_OBJ_FLAG_INITIALIZED</a>  BIT(0)</div><div id="75" class="line none">   75 /** Object is Public */</div><div id="76" class="line none">   76 #define <a href="kobject.h.html#76">K_OBJ_FLAG_PUBLIC</a>       BIT(1)</div><div id="77" class="line none">   77 /** Object allocated */</div><div id="78" class="line none">   78 #define <a href="kobject.h.html#78">K_OBJ_FLAG_ALLOC</a>        BIT(2)</div><div id="79" class="line none">   79 /** Driver Object */</div><div id="80" class="line none">   80 #define <a href="kobject.h.html#80">K_OBJ_FLAG_DRIVER</a>       BIT(3)</div><div id="81" class="line none">   81 </div><div id="82" class="line none">   82 /**</div><div id="83" class="line none">   83  * Grant a thread access to a kernel object</div><div id="84" class="line none">   84  *</div><div id="85" class="line none">   85  * The thread will be granted access to the object if the caller is from</div><div id="86" class="line none">   86  * supervisor mode, or the caller is from user mode AND has permissions</div><div id="87" class="line none">   87  * on both the object and the thread whose access is being granted.</div><div id="88" class="line none">   88  *</div><div id="89" class="line none">   89  * @param object Address of kernel object</div><div id="90" class="line none">   90  * @param thread Thread to grant access to the object</div><div id="91" class="line none">   91  */</div><div id="92" class="line none">   92 __syscall void k_object_access_grant(const void *object,</div><div id="93" class="line none">   93                                      struct <a href="../arch/arch_interface.h.html#43">k_thread</a> *<a href="../kernel.h.html#4031">thread</a>);</div><div id="94" class="line none">   94 </div><div id="95" class="line none">   95 /**</div><div id="96" class="line none">   96  * Revoke a thread's access to a kernel object</div><div id="97" class="line none">   97  *</div><div id="98" class="line none">   98  * The thread will lose access to the object if the caller is from</div><div id="99" class="line none">   99  * supervisor mode, or the caller is from user mode AND has permissions</div><div id="100" class="line none">  100  * on both the object and the thread whose access is being revoked.</div><div id="101" class="line none">  101  *</div><div id="102" class="line none">  102  * @param object Address of kernel object</div><div id="103" class="line none">  103  * @param thread Thread to remove access to the object</div><div id="104" class="line none">  104  */</div><div id="105" class="line none">  105 void <a href="kobject.h.html#167">k_object_access_revoke</a>(const void *object, struct <a href="../arch/arch_interface.h.html#43">k_thread</a> *<a href="../kernel.h.html#4031">thread</a>);</div><div id="106" class="line none">  106 </div><div id="107" class="line none">  107 /**</div><div id="108" class="line none">  108  * @brief Release an object</div><div id="109" class="line none">  109  *</div><div id="110" class="line none">  110  * Allows user threads to drop their own permission on an object</div><div id="111" class="line none">  111  * Their permissions are automatically cleared when a thread terminates.</div><div id="112" class="line none">  112  *</div><div id="113" class="line none">  113  * @param object The object to be released</div><div id="114" class="line none">  114  *</div><div id="115" class="line none">  115  */</div><div id="116" class="line none">  116 __syscall void k_object_release(const void *object);</div><div id="117" class="line none">  117 </div><div id="118" class="line none">  118 /**</div><div id="119" class="line none">  119  * Grant all present and future threads access to an object</div><div id="120" class="line none">  120  *</div><div id="121" class="line none">  121  * If the caller is from supervisor mode, or the caller is from user mode and</div><div id="122" class="line none">  122  * have sufficient permissions on the object, then that object will have</div><div id="123" class="line none">  123  * permissions granted to it for *all* current and future threads running in</div><div id="124" class="line none">  124  * the system, effectively becoming a public kernel object.</div><div id="125" class="line none">  125  *</div><div id="126" class="line none">  126  * Use of this API should be avoided on systems that are running untrusted code</div><div id="127" class="line none">  127  * as it is possible for such code to derive the addresses of kernel objects</div><div id="128" class="line none">  128  * and perform unwanted operations on them.</div><div id="129" class="line none">  129  *</div><div id="130" class="line none">  130  * It is not possible to revoke permissions on public objects; once public,</div><div id="131" class="line none">  131  * any thread may use it.</div><div id="132" class="line none">  132  *</div><div id="133" class="line none">  133  * @param object Address of kernel object</div><div id="134" class="line none">  134  */</div><div id="135" class="line none">  135 void <a href="kobject.h.html#182">k_object_access_all_grant</a>(const void *object);</div><div id="136" class="line none">  136 </div><div id="137" class="line none">  137 /**</div><div id="138" class="line none">  138  * Check if a kernel object is of certain type and is valid.</div><div id="139" class="line none">  139  *</div><div id="140" class="line none">  140  * This checks if the kernel object exists, of certain type,</div><div id="141" class="line none">  141  * and has been initialized.</div><div id="142" class="line none">  142  *</div><div id="143" class="line none">  143  * @param obj Address of the kernel object</div><div id="144" class="line none">  144  * @param otype Object type (use K_OBJ_ANY for ignoring type checking)</div><div id="145" class="line none">  145  * @return True if kernel object (@a obj) exists, of certain type, and</div><div id="146" class="line none">  146  *         has been initialized. False otherwise.</div><div id="147" class="line none">  147  */</div><div id="148" class="line none">  148 bool <a href="kobject.h.html#187">k_object_is_valid</a>(const void *<a href="../kernel.h.html#5739">obj</a>, enum <a href="kobject.h.html#30">k_objects</a> otype);</div><div id="149" class="line none">  149 </div><div id="150" class="line none">  150 #else</div><div id="151" class="line none">  151 /* LCOV_EXCL_START */</div><div id="152" class="line none">  152 #define <a href="kobject.h.html#65">K_THREAD_ACCESS_GRANT</a>(<a href="../kernel.h.html#4031">thread</a>, ...)</div><div id="153" class="line none">  153 </div><div id="154" class="line none">  154 /**</div><div id="155" class="line none">  155  * @internal</div><div id="156" class="line none">  156  */</div><div id="157" class="line none">  157 static inline void <a href="kobject.h.html#157">z_impl_k_object_access_grant</a>(const void *object,</div><div id="158" class="line none">  158                                                 struct <a href="../arch/arch_interface.h.html#43">k_thread</a> *<a href="../kernel.h.html#4031">thread</a>)</div><div id="159" class="line none">  159 {</div><div id="160" class="line none">  160         ARG_UNUSED(object);</div><div id="161" class="line none">  161         ARG_UNUSED(<a href="../kernel.h.html#4031">thread</a>);</div><div id="162" class="line none">  162 }</div><div id="163" class="line none">  163 </div><div id="164" class="line none">  164 /**</div><div id="165" class="line none">  165  * @internal</div><div id="166" class="line none">  166  */</div><div id="167" class="line none">  167 static inline void <a href="kobject.h.html#167">k_object_access_revoke</a>(const void *object,</div><div id="168" class="line none">  168                                           struct <a href="../arch/arch_interface.h.html#43">k_thread</a> *<a href="../kernel.h.html#4031">thread</a>)</div><div id="169" class="line none">  169 {</div><div id="170" class="line none">  170         ARG_UNUSED(object);</div><div id="171" class="line none">  171         ARG_UNUSED(<a href="../kernel.h.html#4031">thread</a>);</div><div id="172" class="line none">  172 }</div><div id="173" class="line none">  173 </div><div id="174" class="line none">  174 /**</div><div id="175" class="line none">  175  * @internal</div><div id="176" class="line none">  176  */</div><div id="177" class="line none">  177 static inline void <a href="kobject.h.html#177">z_impl_k_object_release</a>(const void *object)</div><div id="178" class="line none">  178 {</div><div id="179" class="line none">  179         ARG_UNUSED(object);</div><div id="180" class="line none">  180 }</div><div id="181" class="line none">  181 </div><div id="182" class="line none">  182 static inline void <a href="kobject.h.html#182">k_object_access_all_grant</a>(const void *object)</div><div id="183" class="line none">  183 {</div><div id="184" class="line none">  184         ARG_UNUSED(object);</div><div id="185" class="line none">  185 }</div><div id="186" class="line none">  186 </div><div id="187" class="line none">  187 static inline bool <a href="kobject.h.html#187">k_object_is_valid</a>(const void *<a href="../kernel.h.html#5739">obj</a>, enum <a href="kobject.h.html#30">k_objects</a> otype)</div><div id="188" class="line none">  188 {</div><div id="189" class="line none">  189         ARG_UNUSED(<a href="../kernel.h.html#5739">obj</a>);</div><div id="190" class="line none">  190         ARG_UNUSED(otype);</div><div id="191" class="line none">  191 </div><div id="192" class="line none">  192         return true;</div><div id="193" class="line none">  193 }</div><div id="194" class="line none">  194 </div><div id="195" class="line none">  195 /* LCOV_EXCL_STOP */</div><div id="196" class="line none">  196 #endif /* !CONFIG_USERSPACE */</div><div id="197" class="line none">  197 </div><div id="198" class="line none">  198 #if defined(CONFIG_DYNAMIC_OBJECTS) || defined(__DOXYGEN__)</div><div id="199" class="line none">  199 /**</div><div id="200" class="line none">  200  * Allocate a kernel object of a designated type</div><div id="201" class="line none">  201  *</div><div id="202" class="line none">  202  * This will instantiate at runtime a kernel object of the specified type,</div><div id="203" class="line none">  203  * returning a pointer to it. The object will be returned in an uninitialized</div><div id="204" class="line none">  204  * state, with the calling thread being granted permission on it. The memory</div><div id="205" class="line none">  205  * for the object will be allocated out of the calling thread's resource pool.</div><div id="206" class="line none">  206  *</div><div id="207" class="line none">  207  * @note This function is available only if @kconfig{CONFIG_DYNAMIC_OBJECTS}</div><div id="208" class="line none">  208  * is selected.</div><div id="209" class="line none">  209  *</div><div id="210" class="line none">  210  * @note Thread stack object has to use k_object_alloc_size() since stacks may</div><div id="211" class="line none">  211  * have different sizes.</div><div id="212" class="line none">  212  *</div><div id="213" class="line none">  213  * @param otype Requested kernel object type</div><div id="214" class="line none">  214  * @return A pointer to the allocated kernel object, or NULL if memory wasn't</div><div id="215" class="line none">  215  * available</div><div id="216" class="line none">  216  */</div><div id="217" class="line none">  217 __syscall void *k_object_alloc(enum <a href="kobject.h.html#30">k_objects</a> otype);</div><div id="218" class="line none">  218 </div><div id="219" class="line none">  219 /**</div><div id="220" class="line none">  220  * Allocate a kernel object of a designated type and a given size</div><div id="221" class="line none">  221  *</div><div id="222" class="line none">  222  * This will instantiate at runtime a kernel object of the specified type,</div><div id="223" class="line none">  223  * returning a pointer to it. The object will be returned in an uninitialized</div><div id="224" class="line none">  224  * state, with the calling thread being granted permission on it. The memory</div><div id="225" class="line none">  225  * for the object will be allocated out of the calling thread's resource pool.</div><div id="226" class="line none">  226  *</div><div id="227" class="line none">  227  * This function is specially helpful for thread stack objects because</div><div id="228" class="line none">  228  * their sizes can vary. Other objects should probably look k_object_alloc().</div><div id="229" class="line none">  229  *</div><div id="230" class="line none">  230  * @note This function is available only if @kconfig{CONFIG_DYNAMIC_OBJECTS}</div><div id="231" class="line none">  231  * is selected.</div><div id="232" class="line none">  232  *</div><div id="233" class="line none">  233  * @param otype Requested kernel object type</div><div id="234" class="line none">  234  * @param size Requested kernel object size</div><div id="235" class="line none">  235  * @return A pointer to the allocated kernel object, or NULL if memory wasn't</div><div id="236" class="line none">  236  * available</div><div id="237" class="line none">  237  */</div><div id="238" class="line none">  238 __syscall void *k_object_alloc_size(enum <a href="kobject.h.html#30">k_objects</a> otype, size_t <a href="../kernel.h.html#4716">size</a>);</div><div id="239" class="line none">  239 </div><div id="240" class="line none">  240 /**</div><div id="241" class="line none">  241  * Free a kernel object previously allocated with k_object_alloc()</div><div id="242" class="line none">  242  *</div><div id="243" class="line none">  243  * This will return memory for a kernel object back to resource pool it was</div><div id="244" class="line none">  244  * allocated from.  Care must be exercised that the object will not be used</div><div id="245" class="line none">  245  * during or after when this call is made.</div><div id="246" class="line none">  246  *</div><div id="247" class="line none">  247  * @note This function is available only if @kconfig{CONFIG_DYNAMIC_OBJECTS}</div><div id="248" class="line none">  248  * is selected.</div><div id="249" class="line none">  249  *</div><div id="250" class="line none">  250  * @param obj Pointer to the kernel object memory address.</div><div id="251" class="line none">  251  */</div><div id="252" class="line none">  252 void <a href="kobject.h.html#277">k_object_free</a>(void *<a href="../kernel.h.html#5739">obj</a>);</div><div id="253" class="line none">  253 #else</div><div id="254" class="line none">  254 </div><div id="255" class="line none">  255 /* LCOV_EXCL_START */</div><div id="256" class="line none">  256 static inline void *<a href="kobject.h.html#256">z_impl_k_object_alloc</a>(enum <a href="kobject.h.html#30">k_objects</a> otype)</div><div id="257" class="line none">  257 {</div><div id="258" class="line none">  258         ARG_UNUSED(otype);</div><div id="259" class="line none">  259 </div><div id="260" class="line none">  260         return NULL;</div><div id="261" class="line none">  261 }</div><div id="262" class="line none">  262 </div><div id="263" class="line none">  263 static inline void *<a href="kobject.h.html#263">z_impl_k_object_alloc_size</a>(enum <a href="kobject.h.html#30">k_objects</a> otype,</div><div id="264" class="line none">  264                                         size_t <a href="../kernel.h.html#4716">size</a>)</div><div id="265" class="line none">  265 {</div><div id="266" class="line none">  266         ARG_UNUSED(otype);</div><div id="267" class="line none">  267         ARG_UNUSED(<a href="../kernel.h.html#4716">size</a>);</div><div id="268" class="line none">  268 </div><div id="269" class="line none">  269         return NULL;</div><div id="270" class="line none">  270 }</div><div id="271" class="line none">  271 </div><div id="272" class="line none">  272 /**</div><div id="273" class="line none">  273  * @brief Free an object</div><div id="274" class="line none">  274  *</div><div id="275" class="line none">  275  * @param obj</div><div id="276" class="line none">  276  */</div><div id="277" class="line none">  277 static inline void <a href="kobject.h.html#277">k_object_free</a>(void *<a href="../kernel.h.html#5739">obj</a>)</div><div id="278" class="line none">  278 {</div><div id="279" class="line none">  279         ARG_UNUSED(<a href="../kernel.h.html#5739">obj</a>);</div><div id="280" class="line none">  280 }</div><div id="281" class="line none">  281 /* LCOV_EXCL_STOP */</div><div id="282" class="line none">  282 #endif /* CONFIG_DYNAMIC_OBJECTS */</div><div id="283" class="line none">  283 </div><div id="284" class="line none">  284 /** @} */</div><div id="285" class="line none">  285 </div><div id="286" class="line none">  286 #include &lt;zephyr/syscalls/kobject.h&gt;</div><div id="287" class="line none">  287 #ifdef __cplusplus</div><div id="288" class="line none">  288 }</div><div id="289" class="line none">  289 #endif</div><div id="290" class="line none">  290 </div><div id="291" class="line none">  291 #endif</div>
</div>
</body>
</html>
