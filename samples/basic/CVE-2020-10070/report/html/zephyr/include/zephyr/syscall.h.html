
<html>
<head>
<title>zephyr/include/zephyr/syscall.h</title>
<link rel="stylesheet" type="text/css" href="../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright (c) 2017, Intel Corporation</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * SPDX-License-Identifier: Apache-2.0</div><div id="5" class="line none">    5  */</div><div id="6" class="line none">    6 </div><div id="7" class="line none">    7 </div><div id="8" class="line none">    8 #ifndef <a href="syscall.h.html#9">ZEPHYR_INCLUDE_SYSCALL_H_</a></div><div id="9" class="line none">    9 #define <a href="syscall.h.html#9">ZEPHYR_INCLUDE_SYSCALL_H_</a></div><div id="10" class="line none">   10 </div><div id="11" class="line none">   11 #include &lt;zephyr/syscall_list.h&gt;</div><div id="12" class="line none">   12 #include &lt;zephyr/<a href="kernel/thread.h.html#376">arch</a>/syscall.h&gt;</div><div id="13" class="line none">   13 #include &lt;stdbool.h&gt;</div><div id="14" class="line none">   14 </div><div id="15" class="line none">   15 #ifndef _ASMLANGUAGE</div><div id="16" class="line none">   16 #include &lt;zephyr/types.h&gt;</div><div id="17" class="line none">   17 #include &lt;zephyr/linker/sections.h&gt;</div><div id="18" class="line none">   18 </div><div id="19" class="line none">   19 #ifdef __cplusplus</div><div id="20" class="line none">   20 extern "C" {</div><div id="21" class="line none">   21 #endif</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23 /*</div><div id="24" class="line none">   24  * System Call Declaration macros</div><div id="25" class="line none">   25  *</div><div id="26" class="line none">   26  * These macros are used in public header files to declare system calls.</div><div id="27" class="line none">   27  * They generate inline functions which have different implementations</div><div id="28" class="line none">   28  * depending on the current compilation context:</div><div id="29" class="line none">   29  *</div><div id="30" class="line none">   30  * - Kernel-only code, or CONFIG_USERSPACE disabled, these inlines will</div><div id="31" class="line none">   31  *   directly call the implementation</div><div id="32" class="line none">   32  * - User-only code, these inlines will marshal parameters and elevate</div><div id="33" class="line none">   33  *   privileges</div><div id="34" class="line none">   34  * - Mixed or indeterminate code, these inlines will do a runtime check</div><div id="35" class="line none">   35  *   to determine what course of action is needed.</div><div id="36" class="line none">   36  *</div><div id="37" class="line none">   37  * All system calls require a verifier function and an implementation</div><div id="38" class="line none">   38  * function.  These must follow a naming convention. For a system call</div><div id="39" class="line none">   39  * named k_foo():</div><div id="40" class="line none">   40  *</div><div id="41" class="line none">   41  * - The handler function will be named z_vrfy_k_foo(). Handler</div><div id="42" class="line none">   42  *   functions have the same type signature as the wrapped call,</div><div id="43" class="line none">   43  *   verify arguments passed up from userspace, and call the</div><div id="44" class="line none">   44  *   implementation function. See documentation for that typedef for</div><div id="45" class="line none">   45  *   more information.  - The implementation function will be named</div><div id="46" class="line none">   46  *   z_impl_k_foo(). This is the actual implementation of the system</div><div id="47" class="line none">   47  *   call.</div><div id="48" class="line none">   48  */</div><div id="49" class="line none">   49 </div><div id="50" class="line none">   50 /**</div><div id="51" class="line none">   51  * @typedef _k_syscall_handler_t</div><div id="52" class="line none">   52  * @brief System call handler function type</div><div id="53" class="line none">   53  *</div><div id="54" class="line none">   54  * These are kernel-side skeleton functions for system calls. They are</div><div id="55" class="line none">   55  * necessary to sanitize the arguments passed into the system call:</div><div id="56" class="line none">   56  *</div><div id="57" class="line none">   57  * - Any kernel object or device pointers are validated with _SYSCALL_IS_OBJ()</div><div id="58" class="line none">   58  * - Any memory buffers passed in are checked to ensure that the calling thread</div><div id="59" class="line none">   59  *   actually has access to them</div><div id="60" class="line none">   60  * - Many kernel calls do no sanity checking of parameters other than</div><div id="61" class="line none">   61  *   assertions. The handler must check all of these conditions using</div><div id="62" class="line none">   62  *   _SYSCALL_ASSERT()</div><div id="63" class="line none">   63  * - If the system call has more than 6 arguments, then arg6 will be a pointer</div><div id="64" class="line none">   64  *   to some struct containing arguments 6+. The struct itself needs to be</div><div id="65" class="line none">   65  *   validated like any other buffer passed in from userspace, and its members</div><div id="66" class="line none">   66  *   individually validated (if necessary) and then passed to the real</div><div id="67" class="line none">   67  *   implementation like normal arguments</div><div id="68" class="line none">   68  *</div><div id="69" class="line none">   69  * Even if the system call implementation has no return value, these always</div><div id="70" class="line none">   70  * return something, even 0, to prevent register leakage to userspace.</div><div id="71" class="line none">   71  *</div><div id="72" class="line none">   72  * Once everything has been validated, the real implementation will be executed.</div><div id="73" class="line none">   73  *</div><div id="74" class="line none">   74  * @param arg1 system call argument 1</div><div id="75" class="line none">   75  * @param arg2 system call argument 2</div><div id="76" class="line none">   76  * @param arg3 system call argument 3</div><div id="77" class="line none">   77  * @param arg4 system call argument 4</div><div id="78" class="line none">   78  * @param arg5 system call argument 5</div><div id="79" class="line none">   79  * @param arg6 system call argument 6</div><div id="80" class="line none">   80  * @param ssf System call stack frame pointer. Used to generate kernel oops</div><div id="81" class="line none">   81  *            via _arch_syscall_oops_at(). Contents are arch-specific.</div><div id="82" class="line none">   82  * @return system call return value, or 0 if the system call implementation</div><div id="83" class="line none">   83  *         return void</div><div id="84" class="line none">   84  *</div><div id="85" class="line none">   85  */</div><div id="86" class="line none">   86 typedef uintptr_t (*<a href="syscall.h.html#86">_k_syscall_handler_t</a>)(uintptr_t arg1, uintptr_t arg2,</div><div id="87" class="line none">   87                                           uintptr_t arg3, uintptr_t arg4,</div><div id="88" class="line none">   88                                           uintptr_t arg5, uintptr_t arg6,</div><div id="89" class="line none">   89                                           void *ssf);</div><div id="90" class="line none">   90 </div><div id="91" class="line none">   91 /* True if a syscall function must trap to the kernel, usually a</div><div id="92" class="line none">   92  * compile-time decision.</div><div id="93" class="line none">   93  */</div><div id="94" class="line none">   94 static ALWAYS_INLINE bool <a href="syscall.h.html#94">z_syscall_trap</a>(void)</div><div id="95" class="line none">   95 {</div><div id="96" class="line none">   96         bool ret = false;</div><div id="97" class="line none">   97 #ifdef CONFIG_USERSPACE</div><div id="98" class="line none">   98 #if defined(__ZEPHYR_SUPERVISOR__)</div><div id="99" class="line none">   99         ret = false;</div><div id="100" class="line none">  100 #elif defined(__ZEPHYR_USER__)</div><div id="101" class="line none">  101         ret = true;</div><div id="102" class="line none">  102 #else</div><div id="103" class="line none">  103         ret = arch_is_user_context();</div><div id="104" class="line none">  104 #endif</div><div id="105" class="line none">  105 #endif</div><div id="106" class="line none">  106         return ret;</div><div id="107" class="line none">  107 }</div><div id="108" class="line none">  108 </div><div id="109" class="line none">  109 /**</div><div id="110" class="line none">  110  * Indicate whether the CPU is currently in user mode</div><div id="111" class="line none">  111  *</div><div id="112" class="line none">  112  * @return true if the CPU is currently running with user permissions</div><div id="113" class="line none">  113  */</div><div id="114" class="line none">  114 __pinned_func</div><div id="115" class="line none">  115 static inline bool <a href="syscall.h.html#115">k_is_user_context</a>(void)</div><div id="116" class="line none">  116 {</div><div id="117" class="line none">  117 #ifdef CONFIG_USERSPACE</div><div id="118" class="line none">  118         return arch_is_user_context();</div><div id="119" class="line none">  119 #else</div><div id="120" class="line missed">  120         return false;</div><div id="121" class="line none">  121 #endif</div><div id="122" class="line missed">  122 }</div><div id="123" class="line none">  123 </div><div id="124" class="line none">  124 #ifdef __cplusplus</div><div id="125" class="line none">  125 }</div><div id="126" class="line none">  126 #endif</div><div id="127" class="line none">  127 </div><div id="128" class="line none">  128 #endif /* _ASMLANGUAGE */</div><div id="129" class="line none">  129 </div><div id="130" class="line none">  130 #endif</div>
</div>
</body>
</html>
