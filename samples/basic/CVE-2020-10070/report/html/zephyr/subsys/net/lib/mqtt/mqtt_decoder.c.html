
<html>
<head>
<title>zephyr/subsys/net/lib/mqtt/mqtt_decoder.c</title>
<link rel="stylesheet" type="text/css" href="../../../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright (c) 2018 Nordic Semiconductor ASA</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * SPDX-License-Identifier: Apache-2.0</div><div id="5" class="line none">    5  */</div><div id="6" class="line none">    6 </div><div id="7" class="line none">    7 /** @file mqtt_decoder.c</div><div id="8" class="line none">    8  *</div><div id="9" class="line none">    9  * @brief Decoder functions needed for decoding packets received from the</div><div id="10" class="line none">   10  *        broker.</div><div id="11" class="line none">   11  */</div><div id="12" class="line none">   12 </div><div id="13" class="line none">   13 #include &lt;zephyr/logging/<a href="../../../../include/zephyr/logging/log_msg.h.html#120">log</a>.h&gt;</div><div id="14" class="line none">   14 LOG_MODULE_REGISTER(net_mqtt_dec, CONFIG_MQTT_LOG_LEVEL);</div><div id="15" class="line none">   15 </div><div id="16" class="line none">   16 #include "mqtt_internal.h"</div><div id="17" class="line none">   17 #include "mqtt_os.h"</div><div id="18" class="line none">   18 </div><div id="19" class="line none">   19 /**</div><div id="20" class="line none">   20  * @brief Unpacks unsigned 8 bit value from the buffer from the offset</div><div id="21" class="line none">   21  *        requested.</div><div id="22" class="line none">   22  *</div><div id="23" class="line none">   23  * @param[inout] buf A pointer to the buf_ctx structure containing current</div><div id="24" class="line none">   24  *                   buffer position.</div><div id="25" class="line none">   25  * @param[out] val Memory where the value is to be unpacked.</div><div id="26" class="line none">   26  *</div><div id="27" class="line none">   27  * @retval 0 if the procedure is successful.</div><div id="28" class="line none">   28  * @retval -EINVAL if the buffer would be exceeded during the read</div><div id="29" class="line none">   29  */</div><div id="30" class="line none">   30 static int <a href="mqtt_decoder.c.html#30">unpack_uint8</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, uint8_t *<a href="../../../../include/zephyr/kernel.h.html#2143">val</a>)</div><div id="31" class="line none">   31 {</div><div id="32" class="line none">   32         NET_DBG("&gt;&gt; cur:%p, end:%p", (void *)<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>, (void *)<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#130">end</a>);</div><div id="33" class="line none">   33 </div><div id="34" class="line none">   34         if ((<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#130">end</a> - <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>) &lt; sizeof(uint8_t)) {</div><div id="35" class="line none">   35                 return -EINVAL;</div><div id="36" class="line none">   36         }</div><div id="37" class="line none">   37 </div><div id="38" class="line none">   38         *<a href="../../../../include/zephyr/kernel.h.html#2143">val</a> = *(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>++);</div><div id="39" class="line none">   39 </div><div id="40" class="line none">   40         NET_DBG("&lt;&lt; val:%02x", *<a href="../../../../include/zephyr/kernel.h.html#2143">val</a>);</div><div id="41" class="line none">   41 </div><div id="42" class="line none">   42         return 0;</div><div id="43" class="line none">   43 }</div><div id="44" class="line none">   44 </div><div id="45" class="line none">   45 /**</div><div id="46" class="line none">   46  * @brief Unpacks unsigned 16 bit value from the buffer from the offset</div><div id="47" class="line none">   47  *        requested.</div><div id="48" class="line none">   48  *</div><div id="49" class="line none">   49  * @param[inout] buf A pointer to the buf_ctx structure containing current</div><div id="50" class="line none">   50  *                   buffer position.</div><div id="51" class="line none">   51  * @param[out] val Memory where the value is to be unpacked.</div><div id="52" class="line none">   52  *</div><div id="53" class="line none">   53  * @retval 0 if the procedure is successful.</div><div id="54" class="line none">   54  * @retval -EINVAL if the buffer would be exceeded during the read</div><div id="55" class="line none">   55  */</div><div id="56" class="line none">   56 static int <a href="mqtt_decoder.c.html#56">unpack_uint16</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, uint16_t *<a href="../../../../include/zephyr/kernel.h.html#2143">val</a>)</div><div id="57" class="line none">   57 {</div><div id="58" class="line both">   58         NET_DBG("&gt;&gt; cur:%p, end:%p", (void *)<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>, (void *)<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#130">end</a>);</div><div id="59" class="line none">   59 </div><div id="60" class="line hit">   60         if ((<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#130">end</a> - <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>) &lt; sizeof(uint16_t)) {</div><div id="61" class="line hit">   61                 return -EINVAL;</div><div id="62" class="line none">   62         }</div><div id="63" class="line none">   63 </div><div id="64" class="line hit">   64         *<a href="../../../../include/zephyr/kernel.h.html#2143">val</a> = *(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>++) &lt;&lt; 8; /* MSB */</div><div id="65" class="line hit">   65         *<a href="../../../../include/zephyr/kernel.h.html#2143">val</a> |= *(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>++); /* LSB */</div><div id="66" class="line none">   66 </div><div id="67" class="line both">   67         NET_DBG("&lt;&lt; val:%04x", *<a href="../../../../include/zephyr/kernel.h.html#2143">val</a>);</div><div id="68" class="line none">   68 </div><div id="69" class="line hit">   69         return 0;</div><div id="70" class="line hit">   70 }</div><div id="71" class="line none">   71 </div><div id="72" class="line none">   72 /**</div><div id="73" class="line none">   73  * @brief Unpacks utf8 string from the buffer from the offset requested.</div><div id="74" class="line none">   74  *</div><div id="75" class="line none">   75  * @param[inout] buf A pointer to the buf_ctx structure containing current</div><div id="76" class="line none">   76  *                   buffer position.</div><div id="77" class="line none">   77  * @param[out] str Pointer to a string that will hold the string location</div><div id="78" class="line none">   78  *                 in the buffer.</div><div id="79" class="line none">   79  *</div><div id="80" class="line none">   80  * @retval 0 if the procedure is successful.</div><div id="81" class="line none">   81  * @retval -EINVAL if the buffer would be exceeded during the read</div><div id="82" class="line none">   82  */</div><div id="83" class="line none">   83 static int <a href="mqtt_decoder.c.html#83">unpack_utf8_str</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, struct <a href="../../../../include/zephyr/net/mqtt.h.html#152">mqtt_utf8</a> *str)</div><div id="84" class="line none">   84 {</div><div id="85" class="line hit">   85         uint16_t utf8_strlen;</div><div id="86" class="line hit">   86         int err_code;</div><div id="87" class="line none">   87 </div><div id="88" class="line both">   88         NET_DBG("&gt;&gt; cur:%p, end:%p", (void *)<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>, (void *)<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#130">end</a>);</div><div id="89" class="line none">   89 </div><div id="90" class="line hit">   90         err_code = <a href="mqtt_decoder.c.html#56">unpack_uint16</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;utf8_strlen);</div><div id="91" class="line hit">   91         if (err_code != 0) {</div><div id="92" class="line hit">   92                 return err_code;</div><div id="93" class="line none">   93         }</div><div id="94" class="line none">   94 </div><div id="95" class="line hit">   95         if ((<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#130">end</a> - <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>) &lt; utf8_strlen) {</div><div id="96" class="line hit">   96                 return -EINVAL;</div><div id="97" class="line none">   97         }</div><div id="98" class="line none">   98 </div><div id="99" class="line hit">   99         str-&gt;<a href="../../../../include/zephyr/kernel.h.html#4716">size</a> = utf8_strlen;</div><div id="100" class="line none">  100         /* Zero length UTF8 strings permitted. */</div><div id="101" class="line hit">  101         if (utf8_strlen) {</div><div id="102" class="line none">  102                 /* Point to right location in buffer. */</div><div id="103" class="line hit">  103                 str-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#153">utf8</a> = <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>;</div><div id="104" class="line hit">  104                 <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a> += utf8_strlen;</div><div id="105" class="line hit">  105         } else {</div><div id="106" class="line hit">  106                 str-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#153">utf8</a> = NULL;</div><div id="107" class="line none">  107         }</div><div id="108" class="line none">  108 </div><div id="109" class="line both">  109         NET_DBG("&lt;&lt; str_size:%08x", (uint32_t)<a href="mqtt_internal.h.html#76">GET_UT8STR_BUFFER_SIZE</a>(str));</div><div id="110" class="line none">  110 </div><div id="111" class="line hit">  111         return 0;</div><div id="112" class="line hit">  112 }</div><div id="113" class="line none">  113 </div><div id="114" class="line none">  114 /**</div><div id="115" class="line none">  115  * @brief Unpacks binary string from the buffer from the offset requested.</div><div id="116" class="line none">  116  *</div><div id="117" class="line none">  117  * @param[in] length Binary string length.</div><div id="118" class="line none">  118  * @param[inout] buf A pointer to the buf_ctx structure containing current</div><div id="119" class="line none">  119  *                   buffer position.</div><div id="120" class="line none">  120  * @param[out] str Pointer to a binary string that will hold the binary string</div><div id="121" class="line none">  121  *                 location in the buffer.</div><div id="122" class="line none">  122  *</div><div id="123" class="line none">  123  * @retval 0 if the procedure is successful.</div><div id="124" class="line none">  124  * @retval -EINVAL if the buffer would be exceeded during the read</div><div id="125" class="line none">  125  */</div><div id="126" class="line none">  126 static int <a href="mqtt_decoder.c.html#126">unpack_data</a>(uint32_t length, struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>,</div><div id="127" class="line none">  127                        struct <a href="../../../../include/zephyr/net/mqtt.h.html#170">mqtt_binstr</a> *str)</div><div id="128" class="line none">  128 {</div><div id="129" class="line none">  129         NET_DBG("&gt;&gt; cur:%p, end:%p", (void *)<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>, (void *)<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#130">end</a>);</div><div id="130" class="line none">  130 </div><div id="131" class="line none">  131         if ((<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#130">end</a> - <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>) &lt; length) {</div><div id="132" class="line none">  132                 return -EINVAL;</div><div id="133" class="line none">  133         }</div><div id="134" class="line none">  134 </div><div id="135" class="line none">  135         str-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#172">len</a> = length;</div><div id="136" class="line none">  136 </div><div id="137" class="line none">  137         /* Zero length binary strings are permitted. */</div><div id="138" class="line none">  138         if (length &gt; 0) {</div><div id="139" class="line none">  139                 str-&gt;<a href="../../../../include/zephyr/logging/log_msg.h.html#100">data</a> = <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>;</div><div id="140" class="line none">  140                 <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a> += length;</div><div id="141" class="line none">  141         } else {</div><div id="142" class="line none">  142                 str-&gt;<a href="../../../../include/zephyr/logging/log_msg.h.html#100">data</a> = NULL;</div><div id="143" class="line none">  143         }</div><div id="144" class="line none">  144 </div><div id="145" class="line none">  145         NET_DBG("&lt;&lt; bin len:%08x", <a href="mqtt_internal.h.html#79">GET_BINSTR_BUFFER_SIZE</a>(str));</div><div id="146" class="line none">  146 </div><div id="147" class="line none">  147         return 0;</div><div id="148" class="line none">  148 }</div><div id="149" class="line none">  149 </div><div id="150" class="line none">  150 /**@brief Decode MQTT Packet Length in the MQTT fixed header.</div><div id="151" class="line none">  151  *</div><div id="152" class="line none">  152  * @param[inout] buf A pointer to the buf_ctx structure containing current</div><div id="153" class="line none">  153  *                   buffer position.</div><div id="154" class="line none">  154  * @param[out] length Length of variable header and payload in the</div><div id="155" class="line none">  155  *                              MQTT message.</div><div id="156" class="line none">  156  *</div><div id="157" class="line none">  157  * @retval 0 if the procedure is successful.</div><div id="158" class="line none">  158  * @retval -EINVAL if the length decoding would use more that 4 bytes.</div><div id="159" class="line none">  159  * @retval -EAGAIN if the buffer would be exceeded during the read.</div><div id="160" class="line none">  160  */</div><div id="161" class="line none">  161 static int <a href="mqtt_decoder.c.html#161">packet_length_decode</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, uint32_t *length)</div><div id="162" class="line none">  162 {</div><div id="163" class="line none">  163         uint8_t shift = 0U;</div><div id="164" class="line none">  164         uint8_t bytes = 0U;</div><div id="165" class="line none">  165 </div><div id="166" class="line none">  166         *length = 0U;</div><div id="167" class="line none">  167         do {</div><div id="168" class="line none">  168                 if (bytes &gt;= <a href="mqtt_internal.h.html#107">MQTT_MAX_LENGTH_BYTES</a>) {</div><div id="169" class="line none">  169                         return -EINVAL;</div><div id="170" class="line none">  170                 }</div><div id="171" class="line none">  171 </div><div id="172" class="line none">  172                 if (<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a> &gt;= <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#130">end</a>) {</div><div id="173" class="line none">  173                         return -EAGAIN;</div><div id="174" class="line none">  174                 }</div><div id="175" class="line none">  175 </div><div id="176" class="line none">  176                 *length += ((uint32_t)*(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>) &amp; <a href="mqtt_internal.h.html#108">MQTT_LENGTH_VALUE_MASK</a>)</div><div id="177" class="line none">  177                                                                 &lt;&lt; shift;</div><div id="178" class="line none">  178                 shift += <a href="mqtt_internal.h.html#110">MQTT_LENGTH_SHIFT</a>;</div><div id="179" class="line none">  179                 bytes++;</div><div id="180" class="line none">  180         } while ((*(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>++) &amp; <a href="mqtt_internal.h.html#109">MQTT_LENGTH_CONTINUATION_BIT</a>) != 0U);</div><div id="181" class="line none">  181 </div><div id="182" class="line none">  182         if (*length &gt; <a href="mqtt_internal.h.html#73">MQTT_MAX_PAYLOAD_SIZE</a>) {</div><div id="183" class="line none">  183                 return -EINVAL;</div><div id="184" class="line none">  184         }</div><div id="185" class="line none">  185 </div><div id="186" class="line none">  186         NET_DBG("length:0x%08x", *length);</div><div id="187" class="line none">  187 </div><div id="188" class="line none">  188         return 0;</div><div id="189" class="line none">  189 }</div><div id="190" class="line none">  190 </div><div id="191" class="line none">  191 int <a href="mqtt_decoder.c.html#191">fixed_header_decode</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, uint8_t *type_and_flags,</div><div id="192" class="line none">  192                         uint32_t *length)</div><div id="193" class="line none">  193 {</div><div id="194" class="line none">  194         int err_code;</div><div id="195" class="line none">  195 </div><div id="196" class="line none">  196         err_code = <a href="mqtt_decoder.c.html#30">unpack_uint8</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, type_and_flags);</div><div id="197" class="line none">  197         if (err_code != 0) {</div><div id="198" class="line none">  198                 return err_code;</div><div id="199" class="line none">  199         }</div><div id="200" class="line none">  200 </div><div id="201" class="line none">  201         return <a href="mqtt_decoder.c.html#161">packet_length_decode</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, length);</div><div id="202" class="line none">  202 }</div><div id="203" class="line none">  203 </div><div id="204" class="line none">  204 int <a href="mqtt_decoder.c.html#204">connect_ack_decode</a>(const struct <a href="../../../../include/zephyr/net/mqtt.h.html#330">mqtt_client</a> *client, struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>,</div><div id="205" class="line none">  205                        struct <a href="../../../../include/zephyr/net/mqtt.h.html#195">mqtt_connack_param</a> *<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>)</div><div id="206" class="line none">  206 {</div><div id="207" class="line none">  207         int err_code;</div><div id="208" class="line none">  208         uint8_t <a href="../../../../include/zephyr/kernel.h.html#2764">flags</a>, ret_code;</div><div id="209" class="line none">  209 </div><div id="210" class="line none">  210         err_code = <a href="mqtt_decoder.c.html#30">unpack_uint8</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;<a href="../../../../include/zephyr/kernel.h.html#2764">flags</a>);</div><div id="211" class="line none">  211         if (err_code != 0) {</div><div id="212" class="line none">  212                 return err_code;</div><div id="213" class="line none">  213         }</div><div id="214" class="line none">  214 </div><div id="215" class="line none">  215         err_code = <a href="mqtt_decoder.c.html#30">unpack_uint8</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;ret_code);</div><div id="216" class="line none">  216         if (err_code != 0) {</div><div id="217" class="line none">  217                 return err_code;</div><div id="218" class="line none">  218         }</div><div id="219" class="line none">  219 </div><div id="220" class="line none">  220         if (client-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#550">protocol_version</a> == <a href="../../../../include/zephyr/net/mqtt.h.html#87">MQTT_VERSION_3_1_1</a>) {</div><div id="221" class="line none">  221                 <a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#200">session_present_flag</a> =</div><div id="222" class="line none">  222                         <a href="../../../../include/zephyr/kernel.h.html#2764">flags</a> &amp; <a href="mqtt_internal.h.html#70">MQTT_CONNACK_FLAG_SESSION_PRESENT</a>;</div><div id="223" class="line none">  223 </div><div id="224" class="line none">  224                 NET_DBG("[CID %p]: session_present_flag: %d", client,</div><div id="225" class="line none">  225                          <a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#200">session_present_flag</a>);</div><div id="226" class="line none">  226         }</div><div id="227" class="line none">  227 </div><div id="228" class="line none">  228         <a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#205">return_code</a> = (enum <a href="../../../../include/zephyr/net/mqtt.h.html#110">mqtt_conn_return_code</a>)ret_code;</div><div id="229" class="line none">  229 </div><div id="230" class="line none">  230         return 0;</div><div id="231" class="line none">  231 }</div><div id="232" class="line none">  232 </div><div id="233" class="line none">  233 int <a href="mqtt_decoder.c.html#233">publish_decode</a>(uint8_t <a href="../../../../include/zephyr/kernel.h.html#2764">flags</a>, uint32_t var_length, struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>,</div><div id="234" class="line none">  234                    struct <a href="../../../../include/zephyr/net/mqtt.h.html#249">mqtt_publish_param</a> *<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>)</div><div id="235" class="line none">  235 {</div><div id="236" class="line hit">  236         int err_code;</div><div id="237" class="line hit">  237         uint32_t var_header_length;</div><div id="238" class="line none">  238 </div><div id="239" class="line hit">  239         <a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#261">dup_flag</a> = <a href="../../../../include/zephyr/kernel.h.html#2764">flags</a> &amp; <a href="mqtt_internal.h.html#59">MQTT_HEADER_DUP_MASK</a>;</div><div id="240" class="line hit">  240         <a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#266">retain_flag</a> = <a href="../../../../include/zephyr/kernel.h.html#2764">flags</a> &amp; <a href="mqtt_internal.h.html#61">MQTT_HEADER_RETAIN_MASK</a>;</div><div id="241" class="line hit">  241         <a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#253">message</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#180">topic</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#185">qos</a> = ((<a href="../../../../include/zephyr/kernel.h.html#2764">flags</a> &amp; <a href="mqtt_internal.h.html#60">MQTT_HEADER_QOS_MASK</a>) &gt;&gt; 1);</div><div id="242" class="line none">  242 </div><div id="243" class="line hit">  243         err_code = <a href="mqtt_decoder.c.html#83">unpack_utf8_str</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#253">message</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#180">topic</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#180">topic</a>);</div><div id="244" class="line hit">  244         if (err_code != 0) {</div><div id="245" class="line hit">  245                 return err_code;</div><div id="246" class="line none">  246         }</div><div id="247" class="line none">  247 </div><div id="248" class="line hit">  248         var_header_length = <a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#253">message</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#180">topic</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#180">topic</a>.<a href="../../../../include/zephyr/kernel.h.html#4716">size</a> + sizeof(uint16_t);</div><div id="249" class="line none">  249 </div><div id="250" class="line hit">  250         if (<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#253">message</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#180">topic</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#185">qos</a> &gt; <a href="../../../../include/zephyr/net/mqtt.h.html#95">MQTT_QOS_0_AT_MOST_ONCE</a>) {</div><div id="251" class="line hit">  251                 err_code = <a href="mqtt_decoder.c.html#56">unpack_uint16</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#211">message_id</a>);</div><div id="252" class="line hit">  252                 if (err_code != 0) {</div><div id="253" class="line hit">  253                         return err_code;</div><div id="254" class="line none">  254                 }</div><div id="255" class="line none">  255 </div><div id="256" class="line hit">  256                 var_header_length += sizeof(uint16_t);</div><div id="257" class="line none">  257         }</div><div id="258" class="line none">  258 </div><div id="259" class="line hit">  259         if (var_length &lt; var_header_length) {</div><div id="260" class="line both">  260                 NET_ERR("Corrupted PUBLISH message, header length (%u) larger "</div><div id="261" class="line none">  261                          "than total length (%u)", var_header_length,</div><div id="262" class="line none">  262                          var_length);</div><div id="263" class="line hit">  263                 return -EINVAL;</div><div id="264" class="line none">  264         }</div><div id="265" class="line none">  265 </div><div id="266" class="line hit">  266         <a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#253">message</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#191">payload</a>.<a href="../../../../include/zephyr/logging/log_msg.h.html#100">data</a> = NULL;</div><div id="267" class="line hit">  267         <a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#253">message</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#191">payload</a>.<a href="../../../../include/zephyr/net/mqtt.h.html#172">len</a> = var_length - var_header_length;</div><div id="268" class="line none">  268 </div><div id="269" class="line hit">  269         return 0;</div><div id="270" class="line hit">  270 }</div><div id="271" class="line none">  271 </div><div id="272" class="line none">  272 int <a href="mqtt_decoder.c.html#272">publish_ack_decode</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, struct <a href="../../../../include/zephyr/net/mqtt.h.html#209">mqtt_puback_param</a> *<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>)</div><div id="273" class="line none">  273 {</div><div id="274" class="line none">  274         return <a href="mqtt_decoder.c.html#56">unpack_uint16</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#211">message_id</a>);</div><div id="275" class="line none">  275 }</div><div id="276" class="line none">  276 </div><div id="277" class="line none">  277 int <a href="mqtt_decoder.c.html#277">publish_receive_decode</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, struct <a href="../../../../include/zephyr/net/mqtt.h.html#215">mqtt_pubrec_param</a> *<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>)</div><div id="278" class="line none">  278 {</div><div id="279" class="line none">  279         return <a href="mqtt_decoder.c.html#56">unpack_uint16</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#211">message_id</a>);</div><div id="280" class="line none">  280 }</div><div id="281" class="line none">  281 </div><div id="282" class="line none">  282 int <a href="mqtt_decoder.c.html#282">publish_release_decode</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, struct <a href="../../../../include/zephyr/net/mqtt.h.html#221">mqtt_pubrel_param</a> *<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>)</div><div id="283" class="line none">  283 {</div><div id="284" class="line none">  284         return <a href="mqtt_decoder.c.html#56">unpack_uint16</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#211">message_id</a>);</div><div id="285" class="line none">  285 }</div><div id="286" class="line none">  286 </div><div id="287" class="line none">  287 int <a href="mqtt_decoder.c.html#287">publish_complete_decode</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>,</div><div id="288" class="line none">  288                             struct <a href="../../../../include/zephyr/net/mqtt.h.html#227">mqtt_pubcomp_param</a> *<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>)</div><div id="289" class="line none">  289 {</div><div id="290" class="line none">  290         return <a href="mqtt_decoder.c.html#56">unpack_uint16</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#211">message_id</a>);</div><div id="291" class="line none">  291 }</div><div id="292" class="line none">  292 </div><div id="293" class="line none">  293 int <a href="mqtt_decoder.c.html#293">subscribe_ack_decode</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, struct <a href="../../../../include/zephyr/net/mqtt.h.html#233">mqtt_suback_param</a> *<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>)</div><div id="294" class="line none">  294 {</div><div id="295" class="line none">  295         int err_code;</div><div id="296" class="line none">  296 </div><div id="297" class="line none">  297         err_code = <a href="mqtt_decoder.c.html#56">unpack_uint16</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#211">message_id</a>);</div><div id="298" class="line none">  298         if (err_code != 0) {</div><div id="299" class="line none">  299                 return err_code;</div><div id="300" class="line none">  300         }</div><div id="301" class="line none">  301 </div><div id="302" class="line none">  302         return <a href="mqtt_decoder.c.html#126">unpack_data</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#130">end</a> - <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>-&gt;<a href="mqtt_internal.h.html#129">cur</a>, <a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#239">return_codes</a>);</div><div id="303" class="line none">  303 }</div><div id="304" class="line none">  304 </div><div id="305" class="line none">  305 int <a href="mqtt_decoder.c.html#305">unsubscribe_ack_decode</a>(struct <a href="mqtt_internal.h.html#128">buf_ctx</a> *<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>,</div><div id="306" class="line none">  306                            struct <a href="../../../../include/zephyr/net/mqtt.h.html#243">mqtt_unsuback_param</a> *<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>)</div><div id="307" class="line none">  307 {</div><div id="308" class="line none">  308         return <a href="mqtt_decoder.c.html#56">unpack_uint16</a>(<a href="../../../../include/zephyr/logging/log_msg.h.html#118">buf</a>, &amp;<a href="../../../../include/zephyr/net/mqtt.h.html#322">param</a>-&gt;<a href="../../../../include/zephyr/net/mqtt.h.html#211">message_id</a>);</div><div id="309" class="line none">  309 }</div>
</div>
</body>
</html>
