
<html>
<head>
<title>zephyr/subsys/net/lib/dns/dns_pack.c</title>
<link rel="stylesheet" type="text/css" href="../../../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright (c) 2016 Intel Corporation</div><div id="3" class="line none">    3  *</div><div id="4" class="line none">    4  * SPDX-License-Identifier: Apache-2.0</div><div id="5" class="line none">    5  */</div><div id="6" class="line none">    6 </div><div id="7" class="line none">    7 #include &lt;string.h&gt;</div><div id="8" class="line none">    8 #include &lt;zephyr/net/buf.h&gt;</div><div id="9" class="line none">    9 </div><div id="10" class="line none">   10 #include "dns_pack.h"</div><div id="11" class="line none">   11 </div><div id="12" class="line none">   12 #include "dns_internal.h"</div><div id="13" class="line none">   13 </div><div id="14" class="line none">   14 static inline uint16_t <a href="dns_pack.c.html#14">dns_strlen</a>(const char *str)</div><div id="15" class="line none">   15 {</div><div id="16" class="line none">   16         if (str == NULL) {</div><div id="17" class="line none">   17                 return 0;</div><div id="18" class="line none">   18         }</div><div id="19" class="line none">   19         return (uint16_t)strlen(str);</div><div id="20" class="line none">   20 }</div><div id="21" class="line none">   21 </div><div id="22" class="line none">   22 int <a href="dns_pack.c.html#22">dns_msg_pack_qname</a>(uint16_t *<a href="../../../../include/zephyr/net/buf.h.html#96">len</a>, uint8_t *buf, uint16_t <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>,</div><div id="23" class="line none">   23                        const char *domain_name)</div><div id="24" class="line none">   24 {</div><div id="25" class="line none">   25         uint16_t dn_size;</div><div id="26" class="line none">   26         uint16_t lb_start;</div><div id="27" class="line none">   27         uint16_t lb_index;</div><div id="28" class="line none">   28         uint16_t lb_size;</div><div id="29" class="line none">   29         uint16_t i;</div><div id="30" class="line none">   30 </div><div id="31" class="line none">   31         lb_start = 0U;</div><div id="32" class="line none">   32         lb_index = 1U;</div><div id="33" class="line none">   33         lb_size = 0U;</div><div id="34" class="line none">   34 </div><div id="35" class="line none">   35         dn_size = <a href="dns_pack.c.html#14">dns_strlen</a>(domain_name);</div><div id="36" class="line none">   36         if (dn_size == 0U) {</div><div id="37" class="line none">   37                 return -EINVAL;</div><div id="38" class="line none">   38         }</div><div id="39" class="line none">   39 </div><div id="40" class="line none">   40         /* traverse the domain name str, including the null-terminator :) */</div><div id="41" class="line none">   41         for (i = 0U; i &lt; dn_size + 1; i++) {</div><div id="42" class="line none">   42                 if (lb_index &gt;= <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>) {</div><div id="43" class="line none">   43                         return -ENOMEM;</div><div id="44" class="line none">   44                 }</div><div id="45" class="line none">   45 </div><div id="46" class="line none">   46                 switch (domain_name[i]) {</div><div id="47" class="line none">   47                 default:</div><div id="48" class="line none">   48                         buf[lb_index] = domain_name[i];</div><div id="49" class="line none">   49                         lb_size += 1U;</div><div id="50" class="line none">   50                         break;</div><div id="51" class="line none">   51                 case '.':</div><div id="52" class="line none">   52                         buf[lb_start] = lb_size;</div><div id="53" class="line none">   53                         lb_size = 0U;</div><div id="54" class="line none">   54                         lb_start = lb_index;</div><div id="55" class="line none">   55                         break;</div><div id="56" class="line none">   56                 case '\0':</div><div id="57" class="line none">   57                         buf[lb_start] = lb_size;</div><div id="58" class="line none">   58                         buf[lb_index] = 0U;</div><div id="59" class="line none">   59                         break;</div><div id="60" class="line none">   60                 }</div><div id="61" class="line none">   61                 lb_index += 1U;</div><div id="62" class="line none">   62         }</div><div id="63" class="line none">   63 </div><div id="64" class="line none">   64         *<a href="../../../../include/zephyr/net/buf.h.html#96">len</a> = lb_index;</div><div id="65" class="line none">   65 </div><div id="66" class="line none">   66         return 0;</div><div id="67" class="line none">   67 }</div><div id="68" class="line none">   68 </div><div id="69" class="line none">   69 static inline void <a href="dns_pack.c.html#69">set_dns_msg_response</a>(struct <a href="dns_pack.h.html#72">dns_msg_t</a> *dns_msg, int <a href="../../../../include/zephyr/net/net_ip.h.html#555">type</a>,</div><div id="70" class="line none">   70                                         uint16_t pos, uint16_t <a href="../../../../include/zephyr/net/buf.h.html#96">len</a>)</div><div id="71" class="line none">   71 {</div><div id="72" class="line none">   72         dns_msg-&gt;<a href="dns_pack.h.html#75">response_type</a> = <a href="../../../../include/zephyr/net/net_ip.h.html#555">type</a>;</div><div id="73" class="line none">   73         dns_msg-&gt;<a href="dns_pack.h.html#76">response_position</a> = pos;</div><div id="74" class="line none">   74         dns_msg-&gt;<a href="dns_pack.h.html#77">response_length</a> = <a href="../../../../include/zephyr/net/buf.h.html#96">len</a>;</div><div id="75" class="line none">   75 }</div><div id="76" class="line none">   76 </div><div id="77" class="line none">   77 /*</div><div id="78" class="line none">   78  * Skip encoded FQDN in DNS message.</div><div id="79" class="line none">   79  * Returns size in bytes of encoded FQDN, or negative error code.</div><div id="80" class="line none">   80  */</div><div id="81" class="line none">   81 static int <a href="dns_pack.c.html#81">skip_fqdn</a>(uint8_t *answer, int buf_sz)</div><div id="82" class="line none">   82 {</div><div id="83" class="line none">   83         int i = 0;</div><div id="84" class="line none">   84 </div><div id="85" class="line none">   85         while (1) {</div><div id="86" class="line none">   86                 if (i &gt;= buf_sz) {</div><div id="87" class="line none">   87                         return -EINVAL;</div><div id="88" class="line none">   88                 }</div><div id="89" class="line none">   89 </div><div id="90" class="line none">   90                 if (answer[i] == 0) {</div><div id="91" class="line none">   91                         i += 1;</div><div id="92" class="line none">   92                         break;</div><div id="93" class="line none">   93                 } else if (answer[i] &gt;= 0xc0) {</div><div id="94" class="line none">   94                         i += 2;</div><div id="95" class="line none">   95                         if (i &gt; buf_sz) {</div><div id="96" class="line none">   96                                 return -EINVAL;</div><div id="97" class="line none">   97                         }</div><div id="98" class="line none">   98                         break;</div><div id="99" class="line none">   99                 } else if (answer[i] &lt; <a href="dns_pack.h.html#26">DNS_LABEL_MAX_SIZE</a>) {</div><div id="100" class="line none">  100                         i += answer[i] + 1;</div><div id="101" class="line none">  101                 } else {</div><div id="102" class="line none">  102                         return -EINVAL;</div><div id="103" class="line none">  103                 }</div><div id="104" class="line none">  104         }</div><div id="105" class="line none">  105 </div><div id="106" class="line none">  106         return i;</div><div id="107" class="line none">  107 }</div><div id="108" class="line none">  108 </div><div id="109" class="line none">  109 int <a href="dns_pack.c.html#109">dns_unpack_answer</a>(struct <a href="dns_pack.h.html#72">dns_msg_t</a> *dns_msg, int dname_ptr, uint32_t *<a href="../../../../include/zephyr/net/net_ip.h.html#547">ttl</a>,</div><div id="110" class="line none">  110                       enum <a href="dns_pack.h.html#88">dns_rr_type</a> *<a href="../../../../include/zephyr/net/net_ip.h.html#555">type</a>)</div><div id="111" class="line none">  111 {</div><div id="112" class="line none">  112         int dname_len;</div><div id="113" class="line none">  113         uint16_t rem_size;</div><div id="114" class="line none">  114         uint16_t pos;</div><div id="115" class="line none">  115         uint16_t <a href="../../../../include/zephyr/net/buf.h.html#96">len</a>;</div><div id="116" class="line none">  116         uint8_t *answer;</div><div id="117" class="line none">  117 </div><div id="118" class="line none">  118         answer = dns_msg-&gt;<a href="dns_pack.h.html#73">msg</a> + dns_msg-&gt;<a href="dns_pack.h.html#80">answer_offset</a>;</div><div id="119" class="line none">  119 </div><div id="120" class="line none">  120         dname_len = <a href="dns_pack.c.html#81">skip_fqdn</a>(answer,</div><div id="121" class="line none">  121                               dns_msg-&gt;<a href="dns_pack.h.html#81">msg_size</a> - dns_msg-&gt;<a href="dns_pack.h.html#80">answer_offset</a>);</div><div id="122" class="line none">  122         if (dname_len &lt; 0) {</div><div id="123" class="line none">  123                 return dname_len;</div><div id="124" class="line none">  124         }</div><div id="125" class="line none">  125 </div><div id="126" class="line none">  126         /*</div><div id="127" class="line none">  127          * We need to be sure this buffer has enough space</div><div id="128" class="line none">  128          * to contain the answer.</div><div id="129" class="line none">  129          *</div><div id="130" class="line none">  130          * size: dname_size + type + class + ttl + rdlength + rdata</div><div id="131" class="line none">  131          *            2     +   2  +   2   +  4  +     2    +  ?</div><div id="132" class="line none">  132          *</div><div id="133" class="line none">  133          * So, answer size &gt;= 12</div><div id="134" class="line none">  134          *</div><div id="135" class="line none">  135          * See RFC-1035 4.1.3. Resource record format</div><div id="136" class="line none">  136          */</div><div id="137" class="line none">  137         rem_size = dns_msg-&gt;<a href="dns_pack.h.html#81">msg_size</a> - dname_len;</div><div id="138" class="line none">  138         if (rem_size &lt; 2 + 2 + 4 + 2) {</div><div id="139" class="line none">  139                 return -EINVAL;</div><div id="140" class="line none">  140         }</div><div id="141" class="line none">  141 </div><div id="142" class="line none">  142         /* Only DNS_CLASS_IN answers. If mDNS is enabled, strip away the</div><div id="143" class="line none">  143          * Cache-Flush bit (highest one).</div><div id="144" class="line none">  144          */</div><div id="145" class="line none">  145         if ((<a href="dns_pack.h.html#306">dns_answer_class</a>(dname_len, answer) &amp;</div><div id="146" class="line none">  146              (IS_ENABLED(CONFIG_MDNS_RESOLVER) ? 0x7fff : 0xffff))</div><div id="147" class="line none">  147                                                         != <a href="dns_pack.h.html#108">DNS_CLASS_IN</a>) {</div><div id="148" class="line none">  148                 return -EINVAL;</div><div id="149" class="line none">  149         }</div><div id="150" class="line none">  150 </div><div id="151" class="line none">  151         /* TTL value */</div><div id="152" class="line none">  152         *<a href="../../../../include/zephyr/net/net_ip.h.html#547">ttl</a> = <a href="dns_pack.h.html#312">dns_answer_ttl</a>(dname_len, answer);</div><div id="153" class="line none">  153         <a href="../../../../include/zephyr/net/buf.h.html#96">len</a> = <a href="dns_pack.h.html#317">dns_answer_rdlength</a>(dname_len, answer);</div><div id="154" class="line none">  154         pos = dns_msg-&gt;<a href="dns_pack.h.html#80">answer_offset</a> + dname_len +</div><div id="155" class="line none">  155                 <a href="dns_pack.h.html#29">DNS_COMMON_UINT_SIZE</a> + /* class length */</div><div id="156" class="line none">  156                 <a href="dns_pack.h.html#29">DNS_COMMON_UINT_SIZE</a> + /* type length */</div><div id="157" class="line none">  157                 <a href="dns_pack.h.html#39">DNS_TTL_LEN</a> +</div><div id="158" class="line none">  158                 <a href="dns_pack.h.html#40">DNS_RDLENGTH_LEN</a>;</div><div id="159" class="line none">  159         *<a href="../../../../include/zephyr/net/net_ip.h.html#555">type</a> = <a href="dns_pack.h.html#300">dns_answer_type</a>(dname_len, answer);</div><div id="160" class="line none">  160 </div><div id="161" class="line none">  161         switch (*<a href="../../../../include/zephyr/net/net_ip.h.html#555">type</a>) {</div><div id="162" class="line none">  162         case <a href="dns_pack.h.html#90">DNS_RR_TYPE_A</a>:</div><div id="163" class="line none">  163         case <a href="dns_pack.h.html#94">DNS_RR_TYPE_AAAA</a>:</div><div id="164" class="line none">  164                 <a href="dns_pack.c.html#69">set_dns_msg_response</a>(dns_msg, <a href="dns_pack.h.html#101">DNS_RESPONSE_IP</a>, pos, <a href="../../../../include/zephyr/net/buf.h.html#96">len</a>);</div><div id="165" class="line none">  165                 return 0;</div><div id="166" class="line none">  166 </div><div id="167" class="line none">  167         case <a href="dns_pack.h.html#91">DNS_RR_TYPE_CNAME</a>:</div><div id="168" class="line none">  168                 <a href="dns_pack.c.html#69">set_dns_msg_response</a>(dns_msg, <a href="dns_pack.h.html#103">DNS_RESPONSE_CNAME_NO_IP</a>,</div><div id="169" class="line none">  169                                      pos, <a href="../../../../include/zephyr/net/buf.h.html#96">len</a>);</div><div id="170" class="line none">  170                 return 0;</div><div id="171" class="line none">  171 </div><div id="172" class="line none">  172         default:</div><div id="173" class="line none">  173                 /* malformed dns answer */</div><div id="174" class="line none">  174                 return -EINVAL;</div><div id="175" class="line none">  175         }</div><div id="176" class="line none">  176 </div><div id="177" class="line none">  177         return 0;</div><div id="178" class="line none">  178 }</div><div id="179" class="line none">  179 </div><div id="180" class="line none">  180 int <a href="dns_pack.c.html#180">dns_unpack_response_header</a>(struct <a href="dns_pack.h.html#72">dns_msg_t</a> *<a href="dns_pack.h.html#73">msg</a>, int src_id)</div><div id="181" class="line none">  181 {</div><div id="182" class="line none">  182         uint8_t *<a href="dns_pack.h.html#126">dns_header</a>;</div><div id="183" class="line none">  183         uint16_t <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>;</div><div id="184" class="line none">  184         int <a href="dns_pack.h.html#145">qdcount</a>;</div><div id="185" class="line none">  185         int <a href="dns_pack.h.html#147">ancount</a>;</div><div id="186" class="line none">  186         int rc;</div><div id="187" class="line none">  187 </div><div id="188" class="line none">  188         <a href="dns_pack.h.html#126">dns_header</a> = <a href="dns_pack.h.html#73">msg</a>-&gt;<a href="dns_pack.h.html#73">msg</a>;</div><div id="189" class="line none">  189         <a href="../../../../include/zephyr/net/buf.h.html#99">size</a> = <a href="dns_pack.h.html#73">msg</a>-&gt;<a href="dns_pack.h.html#81">msg_size</a>;</div><div id="190" class="line none">  190 </div><div id="191" class="line none">  191         if (<a href="../../../../include/zephyr/net/buf.h.html#99">size</a> &lt; <a href="dns_pack.h.html#20">DNS_MSG_HEADER_SIZE</a>) {</div><div id="192" class="line none">  192                 return -ENOMEM;</div><div id="193" class="line none">  193         }</div><div id="194" class="line none">  194 </div><div id="195" class="line none">  195         if (<a href="dns_pack.h.html#193">dns_unpack_header_id</a>(<a href="dns_pack.h.html#126">dns_header</a>) != src_id) {</div><div id="196" class="line none">  196                 return -EINVAL;</div><div id="197" class="line none">  197         }</div><div id="198" class="line none">  198 </div><div id="199" class="line none">  199         if (<a href="dns_pack.h.html#199">dns_header_qr</a>(<a href="dns_pack.h.html#126">dns_header</a>) != <a href="dns_pack.h.html#114">DNS_RESPONSE</a>) {</div><div id="200" class="line none">  200                 return -EINVAL;</div><div id="201" class="line none">  201         }</div><div id="202" class="line none">  202 </div><div id="203" class="line none">  203         if (<a href="dns_pack.h.html#205">dns_header_opcode</a>(<a href="dns_pack.h.html#126">dns_header</a>) != <a href="dns_pack.h.html#113">DNS_QUERY</a>) {</div><div id="204" class="line none">  204                 return -EINVAL;</div><div id="205" class="line none">  205         }</div><div id="206" class="line none">  206 </div><div id="207" class="line none">  207         if (<a href="dns_pack.h.html#235">dns_header_z</a>(<a href="dns_pack.h.html#126">dns_header</a>) != 0) {</div><div id="208" class="line none">  208                 return -EINVAL;</div><div id="209" class="line none">  209         }</div><div id="210" class="line none">  210 </div><div id="211" class="line none">  211         rc = <a href="dns_pack.h.html#241">dns_header_rcode</a>(<a href="dns_pack.h.html#126">dns_header</a>);</div><div id="212" class="line none">  212         switch (rc) {</div><div id="213" class="line none">  213         case <a href="dns_pack.h.html#118">DNS_HEADER_NOERROR</a>:</div><div id="214" class="line none">  214                 break;</div><div id="215" class="line none">  215         default:</div><div id="216" class="line none">  216                 return rc;</div><div id="217" class="line none">  217 </div><div id="218" class="line none">  218         }</div><div id="219" class="line none">  219 </div><div id="220" class="line none">  220         <a href="dns_pack.h.html#145">qdcount</a> = <a href="dns_pack.h.html#252">dns_unpack_header_qdcount</a>(<a href="dns_pack.h.html#126">dns_header</a>);</div><div id="221" class="line none">  221         <a href="dns_pack.h.html#147">ancount</a> = <a href="dns_pack.h.html#263">dns_unpack_header_ancount</a>(<a href="dns_pack.h.html#126">dns_header</a>);</div><div id="222" class="line none">  222 </div><div id="223" class="line none">  223         /* For mDNS (when src_id == 0) the query count is 0 so accept</div><div id="224" class="line none">  224          * the packet in that case.</div><div id="225" class="line none">  225          */</div><div id="226" class="line none">  226         if ((<a href="dns_pack.h.html#145">qdcount</a> &lt; 1 &amp;&amp; src_id &gt; 0) || <a href="dns_pack.h.html#147">ancount</a> &lt; 1) {</div><div id="227" class="line none">  227                 return -EINVAL;</div><div id="228" class="line none">  228         }</div><div id="229" class="line none">  229 </div><div id="230" class="line none">  230         return 0;</div><div id="231" class="line none">  231 }</div><div id="232" class="line none">  232 </div><div id="233" class="line none">  233 static int <a href="dns_pack.c.html#233">dns_msg_pack_query_header</a>(uint8_t *buf, uint16_t <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>, uint16_t <a href="../../../../include/zephyr/net/net_ip.h.html#538">id</a>)</div><div id="234" class="line none">  234 {</div><div id="235" class="line none">  235         uint16_t <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a>;</div><div id="236" class="line none">  236 </div><div id="237" class="line none">  237         if (<a href="../../../../include/zephyr/net/buf.h.html#99">size</a> &lt; <a href="dns_pack.h.html#20">DNS_MSG_HEADER_SIZE</a>) {</div><div id="238" class="line none">  238                 return -ENOMEM;</div><div id="239" class="line none">  239         }</div><div id="240" class="line none">  240 </div><div id="241" class="line none">  241         UNALIGNED_PUT(<a href="../../../../include/zephyr/net/net_ip.h.html#120">htons</a>(<a href="../../../../include/zephyr/net/net_ip.h.html#538">id</a>), (uint16_t *)(buf));</div><div id="242" class="line none">  242 </div><div id="243" class="line none">  243         /* RD = 1, TC = 0, AA = 0, Opcode = 0, QR = 0 &lt;-&gt; 0x01 (1B)</div><div id="244" class="line none">  244          * RCode = 0, Z = 0, RA = 0                   &lt;-&gt; 0x00 (1B)</div><div id="245" class="line none">  245          *</div><div id="246" class="line none">  246          * QDCOUNT = 1                                &lt;-&gt; 0x0001 (2B)</div><div id="247" class="line none">  247          */</div><div id="248" class="line none">  248 </div><div id="249" class="line none">  249         <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> = <a href="dns_pack.h.html#31">DNS_HEADER_ID_LEN</a>;</div><div id="250" class="line none">  250         /* Split the following assignments just in case we need to alter</div><div id="251" class="line none">  251          * the flags in future releases</div><div id="252" class="line none">  252          */</div><div id="253" class="line none">  253         *(buf + <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a>) = <a href="dns_pack.h.html#53">DNS_FLAGS1</a>;           /* QR, Opcode, AA, TC and RD */</div><div id="254" class="line none">  254         *(buf + <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> + 1) = <a href="dns_pack.h.html#54">DNS_FLAGS2</a>;       /* RA, Z and RCODE */</div><div id="255" class="line none">  255 </div><div id="256" class="line none">  256         <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> += <a href="dns_pack.h.html#32">DNS_HEADER_FLAGS_LEN</a>;</div><div id="257" class="line none">  257         /* set question counter */</div><div id="258" class="line none">  258         UNALIGNED_PUT(<a href="../../../../include/zephyr/net/net_ip.h.html#120">htons</a>(1), (uint16_t *)(buf + <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a>));</div><div id="259" class="line none">  259 </div><div id="260" class="line none">  260         <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> += <a href="dns_pack.h.html#35">DNS_QDCOUNT_LEN</a>;</div><div id="261" class="line none">  261         /* set answer and ns rr */</div><div id="262" class="line none">  262         UNALIGNED_PUT(0, (uint32_t *)(buf + <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a>));</div><div id="263" class="line none">  263 </div><div id="264" class="line none">  264         <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> += <a href="dns_pack.h.html#36">DNS_ANCOUNT_LEN</a> + <a href="dns_pack.h.html#37">DNS_NSCOUNT_LEN</a>;</div><div id="265" class="line none">  265         /* set the additional records */</div><div id="266" class="line none">  266         UNALIGNED_PUT(0, (uint16_t *)(buf + <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a>));</div><div id="267" class="line none">  267 </div><div id="268" class="line none">  268         return 0;</div><div id="269" class="line none">  269 }</div><div id="270" class="line none">  270 </div><div id="271" class="line none">  271 int <a href="dns_pack.c.html#271">dns_msg_pack_query</a>(uint8_t *buf, uint16_t *<a href="../../../../include/zephyr/net/buf.h.html#96">len</a>, uint16_t <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>,</div><div id="272" class="line none">  272                        uint8_t *qname, uint16_t qname_len, uint16_t <a href="../../../../include/zephyr/net/net_ip.h.html#538">id</a>,</div><div id="273" class="line none">  273                        enum <a href="dns_pack.h.html#88">dns_rr_type</a> qtype)</div><div id="274" class="line none">  274 {</div><div id="275" class="line none">  275         uint16_t <a href="dns_pack.h.html#81">msg_size</a>;</div><div id="276" class="line none">  276         uint16_t <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a>;</div><div id="277" class="line none">  277         int rc;</div><div id="278" class="line none">  278 </div><div id="279" class="line none">  279         <a href="dns_pack.h.html#81">msg_size</a> = <a href="dns_pack.h.html#20">DNS_MSG_HEADER_SIZE</a> + <a href="dns_pack.h.html#33">DNS_QTYPE_LEN</a> + <a href="dns_pack.h.html#34">DNS_QCLASS_LEN</a>;</div><div id="280" class="line none">  280         if (<a href="dns_pack.h.html#81">msg_size</a> + qname_len &gt; <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>) {</div><div id="281" class="line none">  281                 return -ENOMEM;</div><div id="282" class="line none">  282         }</div><div id="283" class="line none">  283 </div><div id="284" class="line none">  284         rc = <a href="dns_pack.c.html#233">dns_msg_pack_query_header</a>(buf, <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>, <a href="../../../../include/zephyr/net/net_ip.h.html#538">id</a>);</div><div id="285" class="line none">  285         if (rc != 0) {</div><div id="286" class="line none">  286                 return rc;</div><div id="287" class="line none">  287         }</div><div id="288" class="line none">  288 </div><div id="289" class="line none">  289         <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> = <a href="dns_pack.h.html#20">DNS_MSG_HEADER_SIZE</a>;</div><div id="290" class="line none">  290         memcpy(buf + <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a>, qname, qname_len);</div><div id="291" class="line none">  291 </div><div id="292" class="line none">  292         <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> += qname_len;</div><div id="293" class="line none">  293 </div><div id="294" class="line none">  294         /* QType */</div><div id="295" class="line none">  295         UNALIGNED_PUT(<a href="../../../../include/zephyr/net/net_ip.h.html#120">htons</a>(qtype), (uint16_t *)(buf + <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> + 0));</div><div id="296" class="line none">  296         <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> += <a href="dns_pack.h.html#33">DNS_QTYPE_LEN</a>;</div><div id="297" class="line none">  297 </div><div id="298" class="line none">  298         /* QClass */</div><div id="299" class="line none">  299         UNALIGNED_PUT(<a href="../../../../include/zephyr/net/net_ip.h.html#120">htons</a>(<a href="dns_pack.h.html#108">DNS_CLASS_IN</a>), (uint16_t *)(buf + <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a>));</div><div id="300" class="line none">  300 </div><div id="301" class="line none">  301         *<a href="../../../../include/zephyr/net/buf.h.html#96">len</a> = <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> + <a href="dns_pack.h.html#34">DNS_QCLASS_LEN</a>;</div><div id="302" class="line none">  302 </div><div id="303" class="line none">  303         return 0;</div><div id="304" class="line none">  304 }</div><div id="305" class="line none">  305 </div><div id="306" class="line none">  306 static int <a href="dns_pack.c.html#306">dns_find_null</a>(int *qname_size, uint8_t *buf, uint16_t <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>)</div><div id="307" class="line none">  307 {</div><div id="308" class="line hit">  308         *qname_size = 0;</div><div id="309" class="line hit">  309         while (*qname_size &lt; <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>) {</div><div id="310" class="line hit">  310                 if (buf[(*qname_size)++] == 0x00) {</div><div id="311" class="line hit">  311                         return 0;</div><div id="312" class="line none">  312                 }</div><div id="313" class="line hit">  313         }</div><div id="314" class="line none">  314 </div><div id="315" class="line hit">  315         return -ENOMEM;</div><div id="316" class="line hit">  316 }</div><div id="317" class="line none">  317 </div><div id="318" class="line none">  318 int <a href="dns_pack.c.html#318">dns_unpack_response_query</a>(struct <a href="dns_pack.h.html#72">dns_msg_t</a> *dns_msg)</div><div id="319" class="line none">  319 {</div><div id="320" class="line hit">  320         uint8_t *<a href="dns_pack.h.html#156">dns_query</a>;</div><div id="321" class="line hit">  321         uint8_t *buf;</div><div id="322" class="line hit">  322         int remaining_size;</div><div id="323" class="line hit">  323         int qname_size;</div><div id="324" class="line hit">  324         int <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a>;</div><div id="325" class="line hit">  325         int rc;</div><div id="326" class="line none">  326 </div><div id="327" class="line hit">  327         dns_msg-&gt;<a href="dns_pack.h.html#79">query_offset</a> = <a href="dns_pack.h.html#20">DNS_MSG_HEADER_SIZE</a>;</div><div id="328" class="line hit">  328         <a href="dns_pack.h.html#156">dns_query</a> = dns_msg-&gt;<a href="dns_pack.h.html#73">msg</a> + dns_msg-&gt;<a href="dns_pack.h.html#79">query_offset</a>;</div><div id="329" class="line hit">  329         remaining_size = dns_msg-&gt;<a href="dns_pack.h.html#81">msg_size</a> - dns_msg-&gt;<a href="dns_pack.h.html#79">query_offset</a>;</div><div id="330" class="line none">  330 </div><div id="331" class="line hit">  331         rc = <a href="dns_pack.c.html#306">dns_find_null</a>(&amp;qname_size, <a href="dns_pack.h.html#156">dns_query</a>, remaining_size);</div><div id="332" class="line hit">  332         if (rc != 0) {</div><div id="333" class="line hit">  333                 return rc;</div><div id="334" class="line none">  334         }</div><div id="335" class="line none">  335 </div><div id="336" class="line none">  336         /* header already parsed + qname size */</div><div id="337" class="line hit">  337         <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> = dns_msg-&gt;<a href="dns_pack.h.html#79">query_offset</a> + qname_size;</div><div id="338" class="line none">  338 </div><div id="339" class="line none">  339         /* 4 bytes more due to qtype and qclass */</div><div id="340" class="line hit">  340         <a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> += <a href="dns_pack.h.html#33">DNS_QTYPE_LEN</a> + <a href="dns_pack.h.html#34">DNS_QCLASS_LEN</a>;</div><div id="341" class="line hit">  341         if (<a href="../../../../include/zephyr/net/buf.h.html#950">offset</a> &gt;= dns_msg-&gt;<a href="dns_pack.h.html#81">msg_size</a>) {</div><div id="342" class="line hit">  342                 return -ENOMEM;</div><div id="343" class="line none">  343         }</div><div id="344" class="line none">  344 </div><div id="345" class="line hit">  345         buf = <a href="dns_pack.h.html#156">dns_query</a> + qname_size;</div><div id="346" class="line hit">  346         if (<a href="dns_pack.h.html#285">dns_unpack_query_qtype</a>(buf) != <a href="dns_pack.h.html#90">DNS_RR_TYPE_A</a> &amp;&amp;</div><div id="347" class="line hit">  347             <a href="dns_pack.h.html#285">dns_unpack_query_qtype</a>(buf) != <a href="dns_pack.h.html#94">DNS_RR_TYPE_AAAA</a>) {</div><div id="348" class="line hit">  348                 return -EINVAL;</div><div id="349" class="line none">  349         }</div><div id="350" class="line none">  350 </div><div id="351" class="line hit">  351         if (<a href="dns_pack.h.html#295">dns_unpack_query_qclass</a>(buf) != <a href="dns_pack.h.html#108">DNS_CLASS_IN</a>) {</div><div id="352" class="line hit">  352                 return -EINVAL;</div><div id="353" class="line none">  353         }</div><div id="354" class="line none">  354 </div><div id="355" class="line hit">  355         dns_msg-&gt;<a href="dns_pack.h.html#80">answer_offset</a> = dns_msg-&gt;<a href="dns_pack.h.html#79">query_offset</a> + qname_size +</div><div id="356" class="line hit">  356                                  <a href="dns_pack.h.html#33">DNS_QTYPE_LEN</a> + <a href="dns_pack.h.html#34">DNS_QCLASS_LEN</a>;</div><div id="357" class="line none">  357 </div><div id="358" class="line hit">  358         return 0;</div><div id="359" class="line hit">  359 }</div><div id="360" class="line none">  360 </div><div id="361" class="line none">  361 int <a href="dns_pack.c.html#361">dns_copy_qname</a>(uint8_t *buf, uint16_t *<a href="../../../../include/zephyr/net/buf.h.html#96">len</a>, uint16_t <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>,</div><div id="362" class="line none">  362                    struct <a href="dns_pack.h.html#72">dns_msg_t</a> *dns_msg, uint16_t pos)</div><div id="363" class="line none">  363 {</div><div id="364" class="line none">  364         uint16_t <a href="dns_pack.h.html#81">msg_size</a> = dns_msg-&gt;<a href="dns_pack.h.html#81">msg_size</a>;</div><div id="365" class="line none">  365         uint8_t *<a href="dns_pack.h.html#73">msg</a> = dns_msg-&gt;<a href="dns_pack.h.html#73">msg</a>;</div><div id="366" class="line none">  366         uint16_t lb_size;</div><div id="367" class="line none">  367         int rc = -EINVAL;</div><div id="368" class="line none">  368 </div><div id="369" class="line none">  369         *<a href="../../../../include/zephyr/net/buf.h.html#96">len</a> = 0U;</div><div id="370" class="line none">  370 </div><div id="371" class="line none">  371         while (1) {</div><div id="372" class="line none">  372                 if (pos &gt;= <a href="dns_pack.h.html#81">msg_size</a>) {</div><div id="373" class="line none">  373                         rc = -ENOMEM;</div><div id="374" class="line none">  374                         break;</div><div id="375" class="line none">  375                 }</div><div id="376" class="line none">  376 </div><div id="377" class="line none">  377                 lb_size = <a href="dns_pack.h.html#73">msg</a>[pos];</div><div id="378" class="line none">  378 </div><div id="379" class="line none">  379                 /* pointer */</div><div id="380" class="line none">  380                 if (lb_size &gt; <a href="dns_pack.h.html#26">DNS_LABEL_MAX_SIZE</a>) {</div><div id="381" class="line none">  381                         uint8_t mask = <a href="dns_pack.h.html#26">DNS_LABEL_MAX_SIZE</a>;</div><div id="382" class="line none">  382 </div><div id="383" class="line none">  383                         if (pos + 1 &gt;= <a href="dns_pack.h.html#81">msg_size</a>) {</div><div id="384" class="line none">  384                                 rc = -ENOMEM;</div><div id="385" class="line none">  385                                 break;</div><div id="386" class="line none">  386                         }</div><div id="387" class="line none">  387 </div><div id="388" class="line none">  388                         /* See: RFC 1035, 4.1.4. Message compression */</div><div id="389" class="line none">  389                         pos = ((<a href="dns_pack.h.html#73">msg</a>[pos] &amp; mask) &lt;&lt; 8) + <a href="dns_pack.h.html#73">msg</a>[pos + 1];</div><div id="390" class="line none">  390 </div><div id="391" class="line none">  391                         continue;</div><div id="392" class="line none">  392                 }</div><div id="393" class="line none">  393 </div><div id="394" class="line none">  394                 /* validate that the label (i.e. size + elements),</div><div id="395" class="line none">  395                  * fits the current msg buffer</div><div id="396" class="line none">  396                  */</div><div id="397" class="line none">  397                 if (<a href="dns_pack.h.html#23">DNS_LABEL_LEN_SIZE</a> + lb_size &gt; <a href="../../../../include/zephyr/net/buf.h.html#99">size</a> - *<a href="../../../../include/zephyr/net/buf.h.html#96">len</a>) {</div><div id="398" class="line none">  398                         rc = -ENOMEM;</div><div id="399" class="line none">  399                         break;</div><div id="400" class="line none">  400                 }</div><div id="401" class="line none">  401 </div><div id="402" class="line none">  402                 /* copy the lb_size value and label elements */</div><div id="403" class="line none">  403                 memcpy(buf + *<a href="../../../../include/zephyr/net/buf.h.html#96">len</a>, <a href="dns_pack.h.html#73">msg</a> + pos, <a href="dns_pack.h.html#23">DNS_LABEL_LEN_SIZE</a> + lb_size);</div><div id="404" class="line none">  404                 /* update destination buffer len */</div><div id="405" class="line none">  405                 *<a href="../../../../include/zephyr/net/buf.h.html#96">len</a> += <a href="dns_pack.h.html#23">DNS_LABEL_LEN_SIZE</a> + lb_size;</div><div id="406" class="line none">  406                 /* update msg ptr position */</div><div id="407" class="line none">  407                 pos += <a href="dns_pack.h.html#23">DNS_LABEL_LEN_SIZE</a> + lb_size;</div><div id="408" class="line none">  408 </div><div id="409" class="line none">  409                 /* The domain name terminates with the zero length octet</div><div id="410" class="line none">  410                  * for the null label of the root</div><div id="411" class="line none">  411                  */</div><div id="412" class="line none">  412                 if (lb_size == 0U) {</div><div id="413" class="line none">  413                         rc = 0;</div><div id="414" class="line none">  414                         break;</div><div id="415" class="line none">  415                 }</div><div id="416" class="line none">  416         }</div><div id="417" class="line none">  417 </div><div id="418" class="line none">  418         return rc;</div><div id="419" class="line none">  419 }</div><div id="420" class="line none">  420 </div><div id="421" class="line none">  421 int <a href="dns_pack.c.html#421">mdns_unpack_query_header</a>(struct <a href="dns_pack.h.html#72">dns_msg_t</a> *<a href="dns_pack.h.html#73">msg</a>, uint16_t *src_id)</div><div id="422" class="line none">  422 {</div><div id="423" class="line none">  423         uint8_t *<a href="dns_pack.h.html#126">dns_header</a>;</div><div id="424" class="line none">  424         uint16_t <a href="../../../../include/zephyr/net/buf.h.html#99">size</a>;</div><div id="425" class="line none">  425         int <a href="dns_pack.h.html#145">qdcount</a>;</div><div id="426" class="line none">  426 </div><div id="427" class="line none">  427         <a href="dns_pack.h.html#126">dns_header</a> = <a href="dns_pack.h.html#73">msg</a>-&gt;<a href="dns_pack.h.html#73">msg</a>;</div><div id="428" class="line none">  428         <a href="../../../../include/zephyr/net/buf.h.html#99">size</a> = <a href="dns_pack.h.html#73">msg</a>-&gt;<a href="dns_pack.h.html#81">msg_size</a>;</div><div id="429" class="line none">  429 </div><div id="430" class="line none">  430         if (<a href="../../../../include/zephyr/net/buf.h.html#99">size</a> &lt; <a href="dns_pack.h.html#20">DNS_MSG_HEADER_SIZE</a>) {</div><div id="431" class="line none">  431                 return -ENOMEM;</div><div id="432" class="line none">  432         }</div><div id="433" class="line none">  433 </div><div id="434" class="line none">  434         if (<a href="dns_pack.h.html#199">dns_header_qr</a>(<a href="dns_pack.h.html#126">dns_header</a>) != <a href="dns_pack.h.html#113">DNS_QUERY</a>) {</div><div id="435" class="line none">  435                 return -EINVAL;</div><div id="436" class="line none">  436         }</div><div id="437" class="line none">  437 </div><div id="438" class="line none">  438         if (<a href="dns_pack.h.html#205">dns_header_opcode</a>(<a href="dns_pack.h.html#126">dns_header</a>) != <a href="dns_pack.h.html#113">DNS_QUERY</a>) {</div><div id="439" class="line none">  439                 return -EINVAL;</div><div id="440" class="line none">  440         }</div><div id="441" class="line none">  441 </div><div id="442" class="line none">  442         if (<a href="dns_pack.h.html#205">dns_header_opcode</a>(<a href="dns_pack.h.html#126">dns_header</a>) != 0) {</div><div id="443" class="line none">  443                 return -EINVAL;</div><div id="444" class="line none">  444         }</div><div id="445" class="line none">  445 </div><div id="446" class="line none">  446         if (<a href="dns_pack.h.html#241">dns_header_rcode</a>(<a href="dns_pack.h.html#126">dns_header</a>) != 0) {</div><div id="447" class="line none">  447                 return -EINVAL;</div><div id="448" class="line none">  448         }</div><div id="449" class="line none">  449 </div><div id="450" class="line none">  450         <a href="dns_pack.h.html#145">qdcount</a> = <a href="dns_pack.h.html#252">dns_unpack_header_qdcount</a>(<a href="dns_pack.h.html#126">dns_header</a>);</div><div id="451" class="line none">  451         if (<a href="dns_pack.h.html#145">qdcount</a> &lt; 1) {</div><div id="452" class="line none">  452                 return -EINVAL;</div><div id="453" class="line none">  453         }</div><div id="454" class="line none">  454 </div><div id="455" class="line none">  455         if (src_id) {</div><div id="456" class="line none">  456                 *src_id = <a href="dns_pack.h.html#193">dns_unpack_header_id</a>(<a href="dns_pack.h.html#126">dns_header</a>);</div><div id="457" class="line none">  457         }</div><div id="458" class="line none">  458 </div><div id="459" class="line none">  459         <a href="dns_pack.h.html#73">msg</a>-&gt;<a href="dns_pack.h.html#79">query_offset</a> = <a href="dns_pack.h.html#20">DNS_MSG_HEADER_SIZE</a>;</div><div id="460" class="line none">  460 </div><div id="461" class="line none">  461         return <a href="dns_pack.h.html#145">qdcount</a>;</div><div id="462" class="line none">  462 }</div><div id="463" class="line none">  463 </div><div id="464" class="line none">  464 /* Returns the length of the unpacked name */</div><div id="465" class="line none">  465 static int <a href="dns_pack.c.html#465">dns_unpack_name</a>(const uint8_t *<a href="dns_pack.h.html#73">msg</a>, int maxlen, const uint8_t *<a href="../../../../include/zephyr/net/net_ip.h.html#530">src</a>,</div><div id="466" class="line none">  466                            struct <a href="../../../../include/zephyr/net/buf.h.html#1004">net_buf</a> *buf, const uint8_t **eol)</div><div id="467" class="line none">  467 {</div><div id="468" class="line none">  468         int dest_size = <a href="../../../../include/zephyr/net/buf.h.html#2502">net_buf_tailroom</a>(buf);</div><div id="469" class="line none">  469         const uint8_t *end_of_label = NULL;</div><div id="470" class="line none">  470         const uint8_t *curr_src = <a href="../../../../include/zephyr/net/net_ip.h.html#530">src</a>;</div><div id="471" class="line none">  471         int loop_check = 0, <a href="../../../../include/zephyr/net/buf.h.html#96">len</a> = -1;</div><div id="472" class="line none">  472         int label_len;</div><div id="473" class="line none">  473         int val;</div><div id="474" class="line none">  474 </div><div id="475" class="line none">  475         if (curr_src &lt; <a href="dns_pack.h.html#73">msg</a> || curr_src &gt;= (<a href="dns_pack.h.html#73">msg</a> + maxlen)) {</div><div id="476" class="line none">  476                 return -EMSGSIZE;</div><div id="477" class="line none">  477         }</div><div id="478" class="line none">  478 </div><div id="479" class="line none">  479         while ((val = *curr_src++)) {</div><div id="480" class="line none">  480                 if (val &amp; <a href="dns_pack.h.html#42">NS_CMPRSFLGS</a>) {</div><div id="481" class="line none">  481                         /* Follow pointer */</div><div id="482" class="line none">  482                         int pos;</div><div id="483" class="line none">  483 </div><div id="484" class="line none">  484                         if (curr_src &gt;= (<a href="dns_pack.h.html#73">msg</a> + maxlen)) {</div><div id="485" class="line none">  485                                 return -EMSGSIZE;</div><div id="486" class="line none">  486                         }</div><div id="487" class="line none">  487 </div><div id="488" class="line none">  488                         if (<a href="../../../../include/zephyr/net/buf.h.html#96">len</a> &lt; 0) {</div><div id="489" class="line none">  489                                 <a href="../../../../include/zephyr/net/buf.h.html#96">len</a> = curr_src - <a href="../../../../include/zephyr/net/net_ip.h.html#530">src</a> + 1;</div><div id="490" class="line none">  490                         }</div><div id="491" class="line none">  491 </div><div id="492" class="line none">  492                         end_of_label = curr_src + 1;</div><div id="493" class="line none">  493 </div><div id="494" class="line none">  494                         /* Strip compress bits from length calculation */</div><div id="495" class="line none">  495                         pos = ((val &amp; 0x3f) &lt;&lt; 8) | (*curr_src &amp; 0xff);</div><div id="496" class="line none">  496 </div><div id="497" class="line none">  497                         curr_src = <a href="dns_pack.h.html#73">msg</a> + pos;</div><div id="498" class="line none">  498                         if (curr_src &gt;= (<a href="dns_pack.h.html#73">msg</a> + maxlen)) {</div><div id="499" class="line none">  499                                 return -EMSGSIZE;</div><div id="500" class="line none">  500                         }</div><div id="501" class="line none">  501 </div><div id="502" class="line none">  502                         loop_check += 2;</div><div id="503" class="line none">  503                         if (loop_check &gt;= maxlen) {</div><div id="504" class="line none">  504                                 return -EMSGSIZE;</div><div id="505" class="line none">  505                         }</div><div id="506" class="line none">  506                 } else {</div><div id="507" class="line none">  507                         /* Max label length is 64 bytes (because 2 bits are</div><div id="508" class="line none">  508                          * used for pointer)</div><div id="509" class="line none">  509                          */</div><div id="510" class="line none">  510                         label_len = val;</div><div id="511" class="line none">  511                         if (label_len &gt; 63) {</div><div id="512" class="line none">  512                                 return -EMSGSIZE;</div><div id="513" class="line none">  513                         }</div><div id="514" class="line none">  514 </div><div id="515" class="line none">  515                         if (((buf-&gt;<a href="../../../../include/zephyr/net/buf.h.html#89">data</a> + label_len + 1) &gt;=</div><div id="516" class="line none">  516                              (buf-&gt;<a href="../../../../include/zephyr/net/buf.h.html#89">data</a> + dest_size)) ||</div><div id="517" class="line none">  517                             ((curr_src + label_len) &gt;= (<a href="dns_pack.h.html#73">msg</a> + maxlen))) {</div><div id="518" class="line none">  518                                 return -EMSGSIZE;</div><div id="519" class="line none">  519                         }</div><div id="520" class="line none">  520 </div><div id="521" class="line none">  521                         loop_check += label_len + 1;</div><div id="522" class="line none">  522 </div><div id="523" class="line none">  523                         <a href="../../../../include/zephyr/net/buf.h.html#1656">net_buf_add_u8</a>(buf, '.');</div><div id="524" class="line none">  524                         <a href="../../../../include/zephyr/net/buf.h.html#1639">net_buf_add_mem</a>(buf, curr_src, label_len);</div><div id="525" class="line none">  525 </div><div id="526" class="line none">  526                         curr_src += label_len;</div><div id="527" class="line none">  527                 }</div><div id="528" class="line none">  528         }</div><div id="529" class="line none">  529 </div><div id="530" class="line none">  530         buf-&gt;<a href="../../../../include/zephyr/net/buf.h.html#89">data</a>[buf-&gt;<a href="../../../../include/zephyr/net/buf.h.html#96">len</a>] = '\0';</div><div id="531" class="line none">  531 </div><div id="532" class="line none">  532         if (eol) {</div><div id="533" class="line none">  533                 if (!end_of_label) {</div><div id="534" class="line none">  534                         end_of_label = curr_src;</div><div id="535" class="line none">  535                 }</div><div id="536" class="line none">  536 </div><div id="537" class="line none">  537                 *eol = end_of_label;</div><div id="538" class="line none">  538         }</div><div id="539" class="line none">  539 </div><div id="540" class="line none">  540         return buf-&gt;<a href="../../../../include/zephyr/net/buf.h.html#96">len</a>;</div><div id="541" class="line none">  541 }</div><div id="542" class="line none">  542 </div><div id="543" class="line none">  543 const char *<a href="dns_pack.c.html#543">dns_qtype_to_str</a>(enum <a href="dns_pack.h.html#88">dns_rr_type</a> qtype)</div><div id="544" class="line none">  544 {</div><div id="545" class="line none">  545         switch (qtype) {</div><div id="546" class="line none">  546         case <a href="dns_pack.h.html#90">DNS_RR_TYPE_A</a>:</div><div id="547" class="line none">  547                 return "A";</div><div id="548" class="line none">  548         case <a href="dns_pack.h.html#91">DNS_RR_TYPE_CNAME</a>:</div><div id="549" class="line none">  549                 return "CNAME";</div><div id="550" class="line none">  550         case <a href="dns_pack.h.html#92">DNS_RR_TYPE_PTR</a>:</div><div id="551" class="line none">  551                 return "PTR";</div><div id="552" class="line none">  552         case <a href="dns_pack.h.html#93">DNS_RR_TYPE_TXT</a>:</div><div id="553" class="line none">  553                 return "TXT";</div><div id="554" class="line none">  554         case <a href="dns_pack.h.html#94">DNS_RR_TYPE_AAAA</a>:</div><div id="555" class="line none">  555                 return "AAAA";</div><div id="556" class="line none">  556         case <a href="dns_pack.h.html#95">DNS_RR_TYPE_SRV</a>:</div><div id="557" class="line none">  557                 return "SRV";</div><div id="558" class="line none">  558         case <a href="dns_pack.h.html#96">DNS_RR_TYPE_ANY</a>:</div><div id="559" class="line none">  559                 return "ANY";</div><div id="560" class="line none">  560         default:</div><div id="561" class="line none">  561                 break;</div><div id="562" class="line none">  562         }</div><div id="563" class="line none">  563 </div><div id="564" class="line none">  564         return "&lt;unknown&gt;";</div><div id="565" class="line none">  565 }</div><div id="566" class="line none">  566 </div><div id="567" class="line none">  567 int <a href="dns_pack.c.html#567">dns_unpack_query</a>(struct <a href="dns_pack.h.html#72">dns_msg_t</a> *dns_msg, struct <a href="../../../../include/zephyr/net/buf.h.html#1004">net_buf</a> *buf,</div><div id="568" class="line none">  568                      enum <a href="dns_pack.h.html#88">dns_rr_type</a> *qtype, enum <a href="dns_pack.h.html#106">dns_class</a> *qclass)</div><div id="569" class="line none">  569 {</div><div id="570" class="line none">  570         const uint8_t *end_of_label;</div><div id="571" class="line none">  571         uint8_t *<a href="dns_pack.h.html#156">dns_query</a>;</div><div id="572" class="line none">  572         int ret;</div><div id="573" class="line none">  573         int query_type, query_class;</div><div id="574" class="line none">  574 </div><div id="575" class="line none">  575         <a href="dns_pack.h.html#156">dns_query</a> = dns_msg-&gt;<a href="dns_pack.h.html#73">msg</a> + dns_msg-&gt;<a href="dns_pack.h.html#79">query_offset</a>;</div><div id="576" class="line none">  576 </div><div id="577" class="line none">  577         ret = <a href="dns_pack.c.html#465">dns_unpack_name</a>(dns_msg-&gt;<a href="dns_pack.h.html#73">msg</a>, dns_msg-&gt;<a href="dns_pack.h.html#81">msg_size</a>, <a href="dns_pack.h.html#156">dns_query</a>,</div><div id="578" class="line none">  578                               buf, &amp;end_of_label);</div><div id="579" class="line none">  579         if (ret &lt; 0) {</div><div id="580" class="line none">  580                 return ret;</div><div id="581" class="line none">  581         }</div><div id="582" class="line none">  582 </div><div id="583" class="line none">  583         query_type = <a href="dns_pack.h.html#285">dns_unpack_query_qtype</a>(end_of_label);</div><div id="584" class="line none">  584         if (query_type != <a href="dns_pack.h.html#90">DNS_RR_TYPE_A</a> &amp;&amp; query_type != <a href="dns_pack.h.html#94">DNS_RR_TYPE_AAAA</a></div><div id="585" class="line none">  585                 &amp;&amp; query_type != <a href="dns_pack.h.html#92">DNS_RR_TYPE_PTR</a></div><div id="586" class="line none">  586                 &amp;&amp; query_type != <a href="dns_pack.h.html#95">DNS_RR_TYPE_SRV</a></div><div id="587" class="line none">  587                 &amp;&amp; query_type != <a href="dns_pack.h.html#93">DNS_RR_TYPE_TXT</a></div><div id="588" class="line none">  588                 &amp;&amp; query_type != <a href="dns_pack.h.html#96">DNS_RR_TYPE_ANY</a>) {</div><div id="589" class="line none">  589                 return -EINVAL;</div><div id="590" class="line none">  590         }</div><div id="591" class="line none">  591 </div><div id="592" class="line none">  592         query_class = <a href="dns_pack.h.html#295">dns_unpack_query_qclass</a>(end_of_label);</div><div id="593" class="line none">  593         if ((query_class &amp; <a href="dns_pack.h.html#108">DNS_CLASS_IN</a>) != <a href="dns_pack.h.html#108">DNS_CLASS_IN</a>) {</div><div id="594" class="line none">  594                 return -EINVAL;</div><div id="595" class="line none">  595         }</div><div id="596" class="line none">  596 </div><div id="597" class="line none">  597         if (qtype) {</div><div id="598" class="line none">  598                 *qtype = query_type;</div><div id="599" class="line none">  599         }</div><div id="600" class="line none">  600 </div><div id="601" class="line none">  601         if (qclass) {</div><div id="602" class="line none">  602                 *qclass = query_class;</div><div id="603" class="line none">  603         }</div><div id="604" class="line none">  604 </div><div id="605" class="line none">  605         dns_msg-&gt;<a href="dns_pack.h.html#79">query_offset</a> = end_of_label - dns_msg-&gt;<a href="dns_pack.h.html#73">msg</a> + 2 + 2;</div><div id="606" class="line none">  606 </div><div id="607" class="line none">  607         return ret;</div><div id="608" class="line none">  608 }</div>
</div>
</body>
</html>
